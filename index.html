<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Life Compass v3.8 (Fixed & Custom)</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#ffffff">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>window.process = { env: { NODE_ENV: 'production' } };</script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script crossorigin src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f7f7f5;
      --text-primary: #37352f;
      --text-secondary: #787774;
      --border-color: #e9e9e7;
    }

    body { 
      font-family: 'Inter', 'Noto Sans TC', sans-serif; 
      background-color: var(--bg-primary); 
      color: var(--text-primary);
      height: 100vh; 
      overflow-y: auto; 
      overscroll-behavior-y: none; 
    }

    .notion-card {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      transition: background 0.1s ease, box-shadow 0.1s ease;
    }
    .notion-card:hover { background: var(--bg-secondary); }
    
    .notion-btn {
      padding: 6px 12px;
      border-radius: 4px;
      transition: background 0.1s;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .notion-btn:hover { background: rgba(55, 53, 47, 0.08); color: var(--text-primary); }
    .notion-btn-primary { background: #2383e2; color: white !important; }
    .notion-btn-primary:hover { background: #1d70c2; }
    .notion-btn-danger { color: #ef4444; }
    .notion-btn-danger:hover { background: #fee2e2; }
    
    .notion-input {
      border: 1px solid #e9e9e7;
      background: transparent;
      transition: border 0.1s, background 0.1s;
      border-radius: 4px;
    }
    .notion-input:focus {
      background: white;
      border-color: #2383e2;
      outline: none;
      box-shadow: 0 0 0 2px rgba(35, 131, 226, 0.1);
    }

    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e0e0e0; border-radius: 3px; }
    
    /* Modal Animation */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-overlay { animation: fadeIn 0.2s ease-out forwards; }
    .modal-content { animation: scaleIn 0.2s ease-out forwards; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbx4S4xt6GsA_Ffdayxg6xHC3wfiKJGdHO8I9hXciCLD27_wCAXgo5TCrYb4a5qSn-K8mQ/exec";

    const { useState, useEffect, useMemo, useRef, useCallback } = React;
    const { createRoot } = ReactDOM;
    const Recharts = window.Recharts || {};
    const { AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer, Bar, ComposedChart, Line, LineChart, Legend, CartesianGrid } = Recharts;

    // --- Icons ---
    const IconBase = ({ children, size = 18, className = "", ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
    );
    const Icons = {
      Compass: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></IconBase>,
      BookOpen: (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>,
      Target: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>,
      TrendingUp: (p) => <IconBase {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>,
      Zap: (p) => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>,
      Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
      Sparkles: (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3z"/></IconBase>,
      Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
      Settings: (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>,
      Cloud: (p) => <IconBase {...p}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19h-2c-2.485 0-4.5-2.015-4.5-4.5S2.015 10 4.5 10c.174 0 .343.02.51.054C5.83 6.934 8.668 5 11.5 5c4.006 0 7.454 2.816 8.275 6.655 2.484.205 4.225 2.216 4.225 4.845C24 19.015 21.985 21 19.5 21h-2z"/></IconBase>,
      RefreshCw: (p) => <IconBase {...p}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconBase>,
      Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
      Link: (p) => <IconBase {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconBase>,
      Star: (p) => <IconBase {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>,
      Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
      Upload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>,
      CloudUpload: (p) => <IconBase {...p}><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19h-2c-2.485 0-4.5-2.015-4.5-4.5S2.015 10 4.5 10c.174 0 .343.02.51.054C5.83 6.934 8.668 5 11.5 5c4.006 0 7.454 2.816 8.275 6.655 2.484.205 4.225 2.216 4.225 4.845C24 19.015 21.985 21 19.5 21h-2z"/></IconBase>,
      CloudDownload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
      Clock: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>,
      List: (p) => <IconBase {...p}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconBase>,
      CheckSquare: (p) => <IconBase {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>,
      Search: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>,
      Edit2: (p) => <IconBase {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>,
      Lightbulb: (p) => <IconBase {...p}><line x1="9" x2="15" y1="18" y2="18"/><line x1="10" x2="14" y1="22" y2="22"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 16.5 8 4.5 4.5 0 0 0 12 3.5a4.5 4.5 0 0 0-4.5 4.5c0 1.55.8 2.85 2 3.9c.81.92 1.23 1.69 1.5 2.6"/></IconBase>,
      FileText: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>,
      MoreHorizontal: (p) => <IconBase {...p}><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></IconBase>,
      ChevronLeft: (p) => <IconBase {...p}><path d="m15 18-6-6 6-6"/></IconBase>,
      Calendar: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
      Globe: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></IconBase>
    };
    const { Compass, BookOpen, Target, TrendingUp, Zap, Save, Sparkles, Trash2, Calendar, ChevronRight, Settings, Cloud, RefreshCw, Plus, Link, Star, Download, Upload, CloudUpload, CloudDownload, Clock, List, CheckSquare, Search, Edit2, Lightbulb, FileText, MoreHorizontal, ChevronLeft, Globe } = Icons;

    const AppTab = { HOME: 'home', TODO: 'todo', IDEAS: 'ideas', JOURNAL: 'journal', PROJECTS: 'projects', FINANCE: 'finance', COMPASS: 'compass', FAB: 'fab', CALENDAR: 'calendar' };
    
    // --- Data & Utils ---
    const INITIAL_RAW_ASSET_DATA = `
    Dec-20 56 26 46% 30 0 0% 56.0 54% 47.6 6.20 6.2 6.20
    Mar-21 77 41 53% 35 0 0% 77.0 45% 65.4 3.30 3.3 9.50
    Apr-21 87 44 51% 36 0 0% 87.0 41% 70.2 3.80 0.50 10.00
    Jul-21 101.4 38.7 38% 62.7 0 0% 101.4 62% 98.1 4.10 0.30 10.30
    Oct-21 112.2 45.5 41% 66.4 0 0% 112.2 59% 115.3 4.80 0.70 11.00
    Dec-21 115.3 59.3 51% 56 0 0% 115.3 49% 125.2 5.10 0.30 11.30
    Feb-22 124 68.5 55% 56 0 0% 124.0 45% 142.6 0.30 0.30 11.60
    Mar-22 128 56.6 44% 72 0 0% 128.0 56% 147.9 (2.80) (3.10) 8.50
    Apr-22 138 62.2 45% 76.6 0 0% 138.0 56% 164.9 (5.60) (2.80) 5.70
    May-22 135.3 53 49.1 39% 86.2 0 0% 135.3 64% 173.1 (9.72) (4.12) 1.58
    Jun-22 135.6 56.2 51.2 41% 84.4 0 0% 135.6 62% 178.5 (12.02) (2.30) (0.72)
    Jul-22 140.2 50.8 50.2 36% 90 0 0% 140.2 64% 183.9 (10.72) 1.30 0.58
    Aug-22 145.4 63.5 63.6 44% 81.8 0 0% 145.4 56% 189.2 (9.85) 0.87 1.45
    Sep-22 146.9 67.2 61.8 42% 85.1 0 0% 146.9 58% 197.3 (15.35) (5.50) (4.05)
    Oct-22 146.4 68.5 60.4 41% 86 0 0% 146.4 59% 202.6 (17.95) (2.60) (6.65)
    Nov-22 153.0 70.4 68.5 45% 84.5 0 0% 153.0 55% 207.4 (12.31) 5.64 (1.01)
    Dec-22 151.0 87.9 79.9 53% 71.1 0 0% 151.0 47% 212.7 (18.31) (6.00) (7.01)
    Jan-23 162.3 83 77.1 48% 85.2 0 0% 162.3 52% 223.8 4.00 4.00 (3.01)
    Feb-23 175.7 89.5 89.3 51% 86.5 0 0% 175.7 49% 234.8 9.91 5.91 2.90
    Mar-23 178 96.7 94.2 53% 83.8 0 0% 178.0 47% 240.1 7.22 (2.69) 0.21
    Apr-23 286.5 103.2 105.2 37% 181.3 100 35% 0% 186.5 63% 246.7 11.92 4.70 4.91
    May-23 294.2 119.6 117.4 40% 174.6 98.4 33% 0% 195.8 59% 259.5 11.70 (0.22) 4.69
    Jun-23 317 130.6 151.7 48% 165.3 96.9 31% 0% 220.1 52% 267.6 31.30 19.60 24.29
    Jul-23 321.5 140.2 165.2 51% 156.3 95.4 30% 0% 226.1 49% 272.9 35.20 3.90 28.19
    Aug-23 315.9 145.8 161.9 51% 154 93.7 30% 0% 222.2 49% 278.4 26.30 (8.90) 19.29
    Sep-23 321.9 152.1 171.7 53% 150.2 92.2 29% 0% 229.7 47% 283.8 29.80 3.50 22.79
    Oct-23 321.1 155.4 169.7 53% 151.4 90.4 28% 0% 230.7 47% 292.0 24.50 (5.30) 17.49
    Nov-23 328.6 150.6 169.9 52% 158.7 89.1 27% 0% 239.5 48% 297.6 31.50 7.00 24.49
    Dec-23 337.4 165.6 193.0 57% 144.4 87.5 26% 0% 249.9 43% 303.1 39.60 8.10 32.59
    Jan-24 335.7 169.1 197.0 59% 138.7 85.9 26% 0% 249.8 41% 308.7 0.30 0.30 32.89
    Feb-24 364.8 181.9 222.9 61% 141.7 84.1 23% 0% 280.7 39% 320.1 13.40 13.10 45.99
    Mar-24 442.7 196.5 249.7 56% 193 154.7 35% 0% 288.0 44% 325.5 25.70 12.30 58.29
    Apr-24 418.9 200.5 253.6 61% 165.3 127.3 30% 0% 291.6 39% 331.2 27.67 1.97 60.26
    May-24 441.2 220.6 286.5 65% 154.7 125.8 29% 0% 315.4 35% 337 47.59 19.92 80.18
    Jun-24 483.5 233.2 326.2 67% 157.3 124.3 26% 0% 359.2 33% 356.6 74.59 27.00 107.18
    Jul-24 511.1 241.4 362 71% 48.1 122.7 24% 101 20% 388.4 9% 362 102.21 27.62 134.80
    Aug-24 482.7 250.2 333.7 69% 48 121.2 25% 101 21% 361.5 10% 367.3 66.87 (35.34) 99.46
    Sep-24 478.4 255 330.7 69% 46.7 119.7 25% 101 21% 358.7 10% 370.7 59.07 (7.80) 91.66
    Oct-24 513 259.1 366.2 71% 45.8 118.2 23% 101 20% 394.8 9% 377.3 91.51 32.44 124.10
    Nov-24 515.1 264.4 363.5 71% 50.6 116.7 23% 101 20% 398.4 10% 384.4 83.51 (8.00) 116.10
    Dec-24 526.6 241 338.1 64% 73.5 115.1 22% 115 22% 411.5 14% 392 88.70 5.19 121.29
    Jan-25 556 253.4 367.7 66% 73.3 113.6 20% 115 21% 442.4 13% 405.8 17.20 17.20 138.49
    Feb-25 542.2 253 355.6 66% 71.6 112 21% 115 21% 430.2 13% 412.1 4.10 (13.10) 125.39
    Mar-25 508.8 255.2 320.8 63% 73 110.5 22% 115 23% 398.3 14% 416.8 (34.10) (38.20) 87.19
    Apr-25 444.7 150.2 149.4 34% 180.3 108.9 24% 115 26% 335.8 41% 416.8 (91.70) (57.60) 29.59
    May-25 463 180.4 206.9 45% 141.1 107.4 23% 115 25% 355.6 30% 416.8 (63.90) 27.80 57.39
    Jun-25 469.7 186.4 218.1 46% 91.6 105.8 23% 160 34% 363.9 20% 416.8 (58.70) 5.20 62.59
    Jul-25 488.8 191.9 243.1 50% 72.7 104.2 21% 173 35% 384.6 15% 416.8 (38.20) 20.50 83.09
    Aug-25 537.8 194.9 257.9 48% 91.9 130 24% 188 35% 407.8 17% 420 (27.40) 10.80 93.89
    Sep-25 555.7 197.3 259.1 47% 95.6 128.5 23% 201 36% 427.2 17% 425.7 (9.62) 17.78 111.67
    Oct-25 587.1 205.2 291.7 50% 94.4 127.1 22% 201 34% 460.0 16% 431.3 15.18 24.80 136.47
    `;

    function calculateXIRR_Newton(transactions, guess = 0.1) {
      if (transactions.length < 2) return 0;
      const d0 = transactions[0].date;
      const func = (r) => transactions.reduce((sum, t) => sum + t.amount / Math.pow(1 + r, (t.date - d0) / (1000 * 60 * 60 * 24 * 365)), 0);
      const deriv = (r) => transactions.reduce((sum, t) => {
          const days = (t.date - d0) / (1000 * 60 * 60 * 24 * 365);
          return sum - days * t.amount / Math.pow(1 + r, days + 1);
      }, 0);
      let r = guess;
      for (let i = 0; i < 50; i++) {
          const f = func(r);
          const df = deriv(r);
          if (Math.abs(f) < 0.0001) return r;
          if (df === 0) return r;
          r = r - f / df;
      }
      return r;
    }

    function parseAssetData(rawText) {
       const lines = rawText.trim().split('\n');
       return lines.map(line => {
           if (!line.trim()) return null;
           const tokens = line.trim().split(/[ \t]+/);
           const dateStr = tokens[0];
           const parts = dateStr.split('-');
           const monthMap = { 'Jan':'01','Feb':'02','Mar':'03','Apr':'04','May':'05','Jun':'06','Jul':'07','Aug':'08','Sep':'09','Oct':'10','Nov':'11','Dec':'12' };
           const date = `20${parts[1]}-${monthMap[parts[0]] || '01'}-01`;
           const percIndices = [];
           tokens.forEach((t, idx) => { if (t.includes('%')) percIndices.push(idx); });
           let total = parseFloat(tokens[1].replace(/,/g, ''));
           let principal = parseFloat(tokens[2].replace(/,/g, ''));
           let lastPercIdx = percIndices[percIndices.length - 1];
           let netAssetsToken = tokens[lastPercIdx - 1];
           let netAssets = parseFloat(netAssetsToken.replace(/,/g, ''));
           
           let firstPercIdx = percIndices[0];
           let invBook = 0;
           if (firstPercIdx > 3) invBook = parseFloat(tokens[3].replace(/,/g, ''));
           let pool = [];
           for (let i = firstPercIdx + 1; i < lastPercIdx - 1; i++) {
               let t = tokens[i];
               if (t.includes('%')) continue;
               let val = parseFloat(t.replace(/,/g, ''));
               if (!isNaN(val)) pool.push(val);
           }
           let cash = 0, loan = 0, house = 0;
           if (pool.length === 3) { cash = pool[0]; loan = pool[1]; house = pool[2]; }
           else if (pool.length === 2) { cash = pool[0]; loan = pool[1]; house = 0; }
           else if (pool.length === 1) { cash = pool[0]; loan = 0; house = 0; }
           if (!invBook) invBook = total - cash - house;
           let calculatedLoan = total - netAssets;
           if (Math.abs(calculatedLoan - loan) > 5) loan = Math.max(0, calculatedLoan);
           return { rawDate: dateStr, date, total, principal, netAssets, loan, house, cash, invBook };
       }).filter(x => x !== null).sort((a,b) => new Date(a.date) - new Date(b.date));
    }

    const downloadFile = (content, filename, type = 'text/markdown') => {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    };

    const importFile = (e, callback) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => callback(event.target.result);
        reader.readAsText(file);
    };

    // --- 1. Custom Confirm Modal ---
    const ConfirmModal = ({ isOpen, message, onConfirm, onCancel }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 modal-overlay">
          <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl modal-content border border-slate-100">
            <h3 className="font-bold text-lg mb-2 text-slate-800">確認刪除？</h3>
            <p className="text-slate-600 mb-6 text-sm">{message}</p>
            <div className="flex justify-end gap-2">
              <button onClick={onCancel} className="px-4 py-2 rounded-lg text-slate-500 hover:bg-slate-50 font-medium text-sm">取消</button>
              <button onClick={onConfirm} className="px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 shadow-sm font-medium text-sm">刪除</button>
            </div>
          </div>
        </div>
      );
    };

    // --- 2. Components ---

    const HomeView = ({ onNavigate }) => {
        const gridItems = [
            { id: 'todo', label: '速記任務', icon: List, color: 'text-slate-700', bg: 'bg-white', action: () => onNavigate(AppTab.TODO) },
            { id: 'idea', label: '靈感捕捉', icon: Lightbulb, color: 'text-amber-500', bg: 'bg-white', action: () => onNavigate(AppTab.IDEAS) },
            { id: 'fab', label: 'FAB 優勢', icon: Zap, color: 'text-yellow-600', bg: 'bg-white', action: () => onNavigate(AppTab.FAB) },
            ...Array(6).fill(null).map((_, i) => ({ id: `empty${i}`, label: 'Empty', icon: Plus, color: 'text-slate-200', bg: 'bg-transparent', action: () => {} }))
        ];

        return (
            <div className="space-y-6 pb-20">
                <h2 className="text-xl font-bold text-slate-800 px-2">Apps</h2>
                <div className="grid grid-cols-3 gap-4 px-2">
                    {gridItems.map(item => (
                        <div key={item.id} onClick={item.action} className={`aspect-square rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all ${item.id.startsWith('empty') ? 'border border-dashed border-slate-200' : 'notion-card shadow-sm active:scale-95'}`}>
                            <item.icon size={28} className={`${item.color} mb-2`} strokeWidth={1.5} />
                            <span className={`text-xs font-medium ${item.id.startsWith('empty') ? 'text-slate-200' : 'text-slate-600'}`}>{item.label}</span>
                        </div>
                    ))}
                </div>
            </div>
        );
    };

    const TodoView = ({ todos, onUpdateTodos, askConfirm }) => {
        const [input, setInput] = useState('');
        const [search, setSearch] = useState('');
        const [editingId, setEditingId] = useState(null);
        const [editContent, setEditContent] = useState('');

        const addTodo = () => {
            if (!input.trim()) return;
            const tags = (input.match(/#[\w\u4e00-\u9fa5]+/g) || []).map(t => t.substring(1));
            const newTodo = { id: Date.now().toString(), content: input, tags: tags, date: new Date().toISOString(), completed: false };
            onUpdateTodos([newTodo, ...todos]);
            setInput('');
        };
        const saveEdit = () => {
            const tags = (editContent.match(/#[\w\u4e00-\u9fa5]+/g) || []).map(t => t.substring(1));
            onUpdateTodos(todos.map(t => t.id === editingId ? { ...t, content: editContent, tags: tags } : t));
            setEditingId(null);
        };
        const toggleTodo = (id) => onUpdateTodos(todos.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
        const deleteTodo = (id) => { askConfirm("確定要刪除此任務嗎？", () => onUpdateTodos(todos.filter(t => t.id !== id))); };
        const filteredTodos = todos.filter(t => t.content.toLowerCase().includes(search.toLowerCase()) || t.tags.some(tag => tag.toLowerCase().includes(search.toLowerCase())));

        const exportMD = () => {
            let md = `| Status | Task | Date |\n|---|---|---|\n`;
            todos.forEach(t => md += `| ${t.completed?'x':' '} | ${t.content.replace(/\n/g,' ')} | ${new Date(t.date).toLocaleDateString()} |\n`);
            downloadFile(md, 'todos.md');
        };
        const importMD = (content) => {
            const lines = content.split('\n').filter(l => l.startsWith('|') && !l.includes('Status'));
            const newTodos = lines.map(l => {
                const parts = l.split('|').map(p => p.trim());
                if(parts.length < 3) return null;
                return { id: Date.now() + Math.random().toString(), content: parts[2], tags: [], date: new Date().toISOString(), completed: parts[1] === 'x' };
            }).filter(x=>x);
            if(newTodos.length > 0) { if(confirm(`Import ${newTodos.length} tasks?`)) onUpdateTodos([...newTodos, ...todos]); }
        };

        return (
            <div className="space-y-4 pb-20 h-full flex flex-col">
                <div className="flex justify-between items-center px-1">
                    <h2 className="text-xl font-bold">速記任務</h2>
                    <div className="flex gap-2">
                        <label className="cursor-pointer text-slate-400 hover:text-slate-800"><Upload size={18}/><input type="file" className="hidden" onChange={e=>importFile(e, importMD)}/></label>
                        <button onClick={exportMD} className="text-slate-400 hover:text-slate-800"><Download size={18}/></button>
                    </div>
                </div>
                <div className="flex gap-2 px-1"><div className="relative flex-1"><Search className="absolute left-3 top-2.5 text-slate-400" size={16}/><input value={search} onChange={e => setSearch(e.target.value)} className="notion-input w-full p-2 pl-9 text-sm bg-slate-50" placeholder="Search..."/></div></div>
                <div className="flex flex-col gap-2 bg-white p-3 rounded-xl border border-slate-200 shadow-sm mx-1">
                    <textarea value={input} onChange={e => setInput(e.target.value)} className="w-full p-2 text-sm resize-none outline-none h-20 bg-transparent placeholder-slate-300" placeholder="New task..." />
                    <div className="flex justify-end"><button onClick={addTodo} className="notion-btn notion-btn-primary text-xs">Add Task</button></div>
                </div>
                <div className="flex-1 overflow-y-auto space-y-2 custom-scrollbar px-1">
                    {filteredTodos.map(t => (
                        <div key={t.id} className={`notion-card p-3 flex items-start gap-3 ${t.completed ? 'opacity-50' : ''}`}>
                            <button onClick={() => toggleTodo(t.id)} className={`mt-0.5 ${t.completed ? 'text-slate-400' : 'text-slate-300 hover:text-indigo-500'}`}><CheckSquare size={18}/></button>
                            <div className="flex-1 min-w-0">
                                {editingId === t.id ? (
                                    <div className="space-y-2"><textarea autoFocus value={editContent} onChange={e => setEditContent(e.target.value)} className="w-full p-2 border rounded text-sm h-20 resize-none"/><div className="flex gap-2 justify-end"><button onClick={()=>setEditingId(null)} className="notion-btn text-xs">Cancel</button><button onClick={saveEdit} className="notion-btn notion-btn-primary text-xs">Save</button></div></div>
                                ) : (
                                    <div onClick={() => {setEditingId(t.id); setEditContent(t.content)}} className="cursor-pointer group">
                                        <div className={`text-sm whitespace-pre-wrap break-words ${t.completed ? 'line-through' : ''}`}>{t.content}</div>
                                        <div className="flex flex-wrap gap-1 mt-2">
                                            <span className="text-[10px] text-slate-400 flex items-center"><Clock size={10} className="mr-1"/>{new Date(t.date).toLocaleDateString()}</span>
                                            {t.tags.map(tag => <span key={tag} className="text-[10px] px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded-md">#{tag}</span>)}
                                        </div>
                                    </div>
                                )}
                            </div>
                            <button onClick={() => deleteTodo(t.id)} className="text-slate-200 hover:text-red-400"><Trash2 size={16}/></button>
                        </div>
                    ))}
                </div>
            </div>
        );
    };

    const CalendarView = ({ todos, projects }) => {
        const [currentDate, setCurrentDate] = useState(new Date());
        const [selectedDate, setSelectedDate] = useState(new Date());
        const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay(); 
        const generateCalendar = () => {
            let days = [];
            for (let i = 0; i < firstDay; i++) days.push(null);
            for (let i = 1; i <= daysInMonth; i++) days.push(new Date(currentDate.getFullYear(), currentDate.getMonth(), i));
            return days;
        };
        const itemsOnDate = (date) => {
            if (!date) return { todos: [], projects: [] };
            const dateStr = date.toDateString();
            const t = todos.filter(todo => new Date(todo.date).toDateString() === dateStr);
            const p = projects.filter(proj => proj.dueDate && new Date(proj.dueDate).toDateString() === dateStr);
            return { todos: t, projects: p };
        };
        const selectedItems = itemsOnDate(selectedDate);

        return (
            <div className="space-y-4 pb-20 h-full flex flex-col">
                <div className="flex justify-between items-center px-2">
                    <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))}><ChevronLeft size={20}/></button>
                    <h2 className="text-lg font-bold">{currentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}</h2>
                    <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))} className="rotate-180"><ChevronLeft size={20}/></button>
                </div>
                <div className="grid grid-cols-7 gap-1 px-2 text-center text-xs text-slate-400 font-bold"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div>
                <div className="grid grid-cols-7 gap-1 px-2">
                    {generateCalendar().map((d, i) => {
                        const { todos, projects } = itemsOnDate(d);
                        const hasItems = todos.length > 0 || projects.length > 0;
                        const isSelected = d && d.toDateString() === selectedDate.toDateString();
                        return (
                            <div key={i} onClick={() => d && setSelectedDate(d)} className={`aspect-square flex flex-col items-center justify-center rounded-lg text-sm cursor-pointer ${!d ? 'invisible' : ''} ${isSelected ? 'bg-slate-800 text-white' : 'hover:bg-slate-50 text-slate-700'}`}>
                                {d && d.getDate()}
                                {hasItems && <div className={`w-1 h-1 rounded-full mt-1 ${isSelected ? 'bg-white' : 'bg-indigo-500'}`}></div>}
                            </div>
                        )
                    })}
                </div>
                <div className="flex-1 bg-slate-50 border-t border-slate-200 p-4 overflow-y-auto custom-scrollbar space-y-4">
                    <h3 className="font-bold text-slate-700">{selectedDate.toLocaleDateString()}</h3>
                    <div>
                        <h4 className="text-xs font-bold text-slate-400 uppercase mb-2">Projects Due</h4>
                        {selectedItems.projects.length > 0 ? selectedItems.projects.map(p => (
                            <div key={p.id} className="bg-white p-3 rounded border border-slate-200 mb-2 text-sm">
                                <div className="font-bold">{p.title}</div>
                                <div className="text-xs text-slate-500">{p.content}</div>
                            </div>
                        )) : <div className="text-xs text-slate-400 italic">No projects due.</div>}
                    </div>
                    <div>
                        <h4 className="text-xs font-bold text-slate-400 uppercase mb-2">Quick Tasks</h4>
                        {selectedItems.todos.length > 0 ? selectedItems.todos.map(t => (
                            <div key={t.id} className="bg-white p-3 rounded border border-slate-200 mb-2 text-sm flex items-center gap-2">
                                <div className={`w-2 h-2 rounded-full ${t.completed ? 'bg-green-400' : 'bg-slate-300'}`}></div>
                                <span className={t.completed ? 'line-through text-slate-400' : ''}>{t.content}</span>
                            </div>
                        )) : <div className="text-xs text-slate-400 italic">No tasks.</div>}
                    </div>
                </div>
            </div>
        );
    };

    // Finance View (Fixed: Safe render for blank table issue)
    const FinanceView = ({ data, onAddData, onDeleteData, askConfirm }) => {
      const [newData, setNewData] = useState({ date: new Date().toISOString().slice(0,7), principal: '', inv: '', cash: '', house: '', loan: '' });
      const [showForm, setShowForm] = useState(false);
      const [showHistory, setShowHistory] = useState(false);

      const annualXIRR = useMemo(() => {
        if (!data || data.length === 0) return [];
        const years = [...new Set(data.map(d => d.date.substring(0, 4)))].sort().filter(y => parseInt(y) >= 2021);
        return years.map(year => {
          const prevData = data.find(d => d.date.startsWith(`${parseInt(year)-1}-12`)) || data.find(d => d.date.startsWith(`${parseInt(year)-1}-`));
          const currData = data.filter(d => d.date.startsWith(`${year}-`));
          if (!prevData || currData.length === 0) return null;
          let trans = [{ amount: -prevData.netAssets, date: new Date(`${year}-01-01`) }];
          let prevPrin = prevData.principal;
          currData.forEach(r => {
             const diff = r.principal - prevPrin;
             if (Math.abs(diff) > 0.01) trans.push({ amount: -diff, date: new Date(r.date) });
             prevPrin = r.principal;
          });
          trans.push({ amount: currData[currData.length-1].netAssets, date: new Date(currData[currData.length-1].date) });
          return { year, val: calculateXIRR_Newton(trans) * 100 };
        }).filter(Boolean);
      }, [data]);

      const handleSubmit = () => {
         const total = parseFloat(newData.inv) + parseFloat(newData.cash) + parseFloat(newData.house);
         const net = total - parseFloat(newData.loan);
         const entry = {
            rawDate: newData.date,
            date: newData.date + "-01",
            total, principal: parseFloat(newData.principal), netAssets: net,
            invBook: parseFloat(newData.inv), cash: parseFloat(newData.cash), house: parseFloat(newData.house), loan: parseFloat(newData.loan)
         };
         onAddData(entry);
         setShowForm(false);
      };

      const handleDeleteMonth = (index, rawDate) => {
          askConfirm(`確定要刪除 ${rawDate} 的資產數據嗎？`, () => {
             onDeleteData(index);
          });
      };

      // Safe Render Helper
      const safeNetAssets = (row) => {
          try {
              return row && row.netAssets ? row.netAssets.toLocaleString() : '0';
          } catch (e) { return 'Error'; }
      };

      return (
        <div className="space-y-6 pb-20">
          <div className="flex justify-between items-center px-2 pt-2">
            <h2 className="text-2xl font-black text-slate-900 flex items-center"><TrendingUp className="mr-2 text-indigo-600"/>資產戰情室</h2>
            <button onClick={() => setShowForm(!showForm)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700">
                {showForm ? "取消" : "+ 紀錄"}
            </button>
          </div>

          <div className="grid grid-cols-3 gap-2 px-2">
            {annualXIRR.slice(-6).map(i => (
              <div key={i.year} className="bg-white p-3 rounded-xl border border-slate-100 text-center shadow-sm">
                <div className="text-xs text-slate-500 font-bold">{i.year} IRR</div>
                <div className={`text-lg font-black ${i.val >= 0 ? 'text-indigo-600' : 'text-slate-400'}`}>{i.val.toFixed(1)}%</div>
              </div>
            ))}
          </div>

          {showForm && (
            <div className="bg-white p-4 mx-2 rounded-xl border-l-4 border-indigo-500 shadow-lg space-y-4 animate-pulse-subtle">
               <div className="grid grid-cols-2 gap-3">
                  <input type="month" value={newData.date} onChange={e=>setNewData({...newData, date:e.target.value})} className="p-2 border rounded text-sm w-full"/>
                  <input type="number" placeholder="投入本金" value={newData.principal} onChange={e=>setNewData({...newData, principal:e.target.value})} className="p-2 border rounded text-sm w-full"/>
               </div>
               <div className="grid grid-cols-3 gap-2">
                  <input type="number" placeholder="投資" value={newData.inv} onChange={e=>setNewData({...newData, inv:e.target.value})} className="p-2 border rounded text-sm w-full"/>
                  <input type="number" placeholder="現金" value={newData.cash} onChange={e=>setNewData({...newData, cash:e.target.value})} className="p-2 border rounded text-sm w-full"/>
                  <input type="number" placeholder="房產" value={newData.house} onChange={e=>setNewData({...newData, house:e.target.value})} className="p-2 border rounded text-sm w-full"/>
               </div>
               <input type="number" placeholder="負債/貸款" value={newData.loan} onChange={e=>setNewData({...newData, loan:e.target.value})} className="w-full p-2 border rounded text-sm"/>
               <button onClick={handleSubmit} className="w-full bg-slate-800 text-white py-2 rounded font-bold hover:bg-slate-900">確認更新</button>
            </div>
          )}

          <div className="bg-white p-4 mx-2 rounded-xl border border-slate-200 shadow-sm h-72">
             <div className="text-sm font-bold text-slate-700 mb-2">淨資產堆疊圖</div>
             <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={data}>
                   <defs>
                      <linearGradient id="colorNet" x1="0" y1="0" x2="0" y2="1">
                         <stop offset="5%" stopColor="#4f46e5" stopOpacity={0.8}/>
                         <stop offset="95%" stopColor="#4f46e5" stopOpacity={0}/>
                      </linearGradient>
                   </defs>
                   <XAxis dataKey="rawDate" hide/>
                   <Tooltip />
                   <Area type="monotone" dataKey="netAssets" stroke="#4f46e5" fillOpacity={1} fill="url(#colorNet)" />
                   <Area type="monotone" dataKey="principal" stroke="#cbd5e1" fill="transparent" strokeDasharray="3 3"/>
                </AreaChart>
             </ResponsiveContainer>
          </div>

          <div className="bg-white p-4 mx-2 rounded-xl border border-slate-200 shadow-sm h-64">
             <div className="text-sm font-bold text-slate-700 mb-2">資產配置與負債</div>
             <ResponsiveContainer width="100%" height="100%">
                <ComposedChart data={data.slice(-12)}>
                   <XAxis dataKey="rawDate" tick={{fontSize:10}}/>
                   <Tooltip />
                   <Bar dataKey="loan" fill="#cbd5e1" stackId="a" />
                   <Bar dataKey="netAssets" fill="#3b82f6" stackId="a" />
                   <Line type="monotone" dataKey="total" stroke="#1e293b" strokeWidth={2} />
                </ComposedChart>
             </ResponsiveContainer>
          </div>

          <div className="px-2">
             <button onClick={() => setShowHistory(!showHistory)} className="w-full py-2 text-sm text-slate-500 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition">
                 {showHistory ? "隱藏歷史數據" : "管理歷史數據"}
             </button>
             {showHistory && (
                 <div className="mt-2 bg-white rounded-xl border border-slate-200 overflow-hidden max-h-96 overflow-y-auto custom-scrollbar">
                     <table className="w-full text-sm text-left">
                         <thead className="bg-slate-50 text-slate-600 font-bold">
                             <tr>
                                 <th className="p-3">月份</th>
                                 <th className="p-3">淨資產</th>
                                 <th className="p-3 text-right">操作</th>
                             </tr>
                         </thead>
                         <tbody className="divide-y divide-slate-100">
                             {(!data || data.length === 0) ? (
                                 <tr><td colSpan="3" className="p-4 text-center text-slate-400">無數據</td></tr>
                             ) : (
                                 [...data].reverse().map((row, idx) => {
                                     // Fixed: Use filter instead of index to safely delete in parent
                                     if (!row) return null;
                                     return (
                                         <tr key={row.rawDate + idx} className="hover:bg-slate-50">
                                             <td className="p-3 text-slate-800 font-medium">{row.rawDate}</td>
                                             <td className="p-3 text-indigo-600 font-bold">{safeNetAssets(row)}</td>
                                             <td className="p-3 text-right">
                                                 <button onClick={() => handleDeleteMonth(data.indexOf(row), row.rawDate)} className="text-red-400 hover:text-red-600 p-1">
                                                     <Trash2 size={16}/>
                                                 </button>
                                             </td>
                                         </tr>
                                     );
                                 })
                             )}
                         </tbody>
                     </table>
                 </div>
             )}
          </div>
        </div>
      );
    };

    // Journal View
    const JournalView = ({ entries, projects, onUpdateEntries, apiKey, categories = [], onUpdateCategories, askConfirm }) => {
      const [isEditing, setIsEditing] = useState(false);
      const [currentEntry, setCurrentEntry] = useState({ id: '', title: '', category: '個人成長', rawContent: '', linkedProjectId: '' });
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const [currentMonth, setCurrentMonth] = useState(new Date()); 
      const [newCat, setNewCat] = useState('');
      const [manageMode, setManageMode] = useState(false);

      const safeCategories = Array.isArray(categories) ? categories : ['個人成長'];
      const activeProjects = useMemo(() => Array.isArray(projects) ? projects.filter(p => p.status !== 'Done') : [], [projects]);
      const monthEntries = entries.filter(e => { const d = new Date(e.date); return d.getFullYear() === currentMonth.getFullYear() && d.getMonth() === currentMonth.getMonth(); });

      const saveEntry = () => {
        const updated = { ...currentEntry, date: currentEntry.date || new Date().toISOString() };
        if (newCat && !safeCategories.includes(newCat)) onUpdateCategories([...safeCategories, newCat]);
        const finalCat = newCat || currentEntry.category;
        const finalUpdated = { ...updated, category: finalCat };
        const exists = entries.find(e => e.id === updated.id);
        onUpdateEntries(exists ? entries.map(e => e.id === updated.id ? finalUpdated : e) : [finalUpdated, ...entries]);
        setIsEditing(false); setNewCat('');
      };

      const deleteEntry = (id) => { 
          askConfirm("確定要刪除這篇覆盤嗎？", () => onUpdateEntries(entries.filter(entry => entry.id !== id))); 
      };
      const deleteCategory = (cat) => { 
          askConfirm(`確定要刪除分類「${cat}」嗎？`, () => onUpdateCategories(safeCategories.filter(c => c !== cat)));
      };

      if (isEditing) {
        return (
          <div className="h-[calc(100vh-140px)] flex flex-col bg-white">
             <div className="p-4 border-b flex justify-between items-center">
                <button onClick={() => setIsEditing(false)} className="notion-btn">Cancel</button>
                <button onClick={saveEntry} className="notion-btn notion-btn-primary">Done</button>
             </div>
             <div className="flex-1 overflow-y-auto p-6 space-y-6">
                <input className="w-full text-2xl font-bold placeholder-slate-300 outline-none" placeholder="Untitled" value={currentEntry.title} onChange={e=>setCurrentEntry({...currentEntry, title:e.target.value})}/>
                <div className="flex flex-wrap gap-4 text-sm text-slate-500">
                   <div className="flex items-center gap-2 w-full sm:w-auto relative">
                      <span>Category:</span>
                      <input list="j-cat-list" className="notion-input flex-1 p-1" value={newCat || currentEntry.category} onChange={e=>{setNewCat(e.target.value); setCurrentEntry({...currentEntry, category:e.target.value})}} placeholder="Select or type new..."/>
                      <datalist id="j-cat-list">{safeCategories.map(c=><option key={c} value={c}/>)}</datalist>
                      <button onClick={()=>setManageMode(!manageMode)} className="text-slate-300 hover:text-slate-600"><Settings size={14}/></button>
                      {manageMode && (
                          <div className="absolute top-8 left-0 bg-white border shadow-lg p-2 rounded z-10 w-48">
                              {safeCategories.map(c => <div key={c} className="flex justify-between p-1 hover:bg-slate-50"><span>{c}</span><button onClick={()=>deleteCategory(c)} className="text-red-400">x</button></div>)}
                          </div>
                      )}
                   </div>
                   <div className="flex items-center gap-2">
                      <span>Project:</span>
                      <select className="bg-slate-50 rounded p-1 max-w-[150px]" value={currentEntry.linkedProjectId} onChange={e=>setCurrentEntry({...currentEntry, linkedProjectId:e.target.value})}><option value="">None</option>{activeProjects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}</select>
                   </div>
                </div>
                <textarea className="w-full h-64 resize-none outline-none text-base leading-relaxed placeholder-slate-300" value={currentEntry.rawContent} onChange={e=>setCurrentEntry({...currentEntry, rawContent:e.target.value})} placeholder="Write your weekly review..."></textarea>
             </div>
          </div>
        );
      }

      return (
         <div className="space-y-4 pb-24">
            <div className="flex justify-between items-center px-2 pt-2">
               <div className="flex items-center">
                   <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()-1)))} className="p-1 hover:bg-slate-100 rounded"><ChevronLeft size={20}/></button>
                   <h2 className="text-lg font-bold text-slate-800 mx-2">{currentMonth.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}</h2>
                   <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()+1)))} className="p-1 hover:bg-slate-100 rounded rotate-180"><ChevronLeft size={20}/></button>
               </div>
            </div>
            <div className="space-y-2 px-2">
                {monthEntries.length > 0 ? monthEntries.map(e => (
                    <div key={e.id} onClick={() => { setCurrentEntry(e); setIsEditing(true); setNewCat(''); }} className="notion-card p-4 cursor-pointer flex justify-between group">
                        <div>
                            <div className="text-xs text-slate-400 mb-1">{new Date(e.date).toLocaleDateString()} • {e.category}</div>
                            <div className="font-bold text-slate-700">{e.title || "Untitled"}</div>
                        </div>
                        <button onClick={(evt) => {evt.stopPropagation(); deleteEntry(e.id)}} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-400 p-2"><Trash2 size={16}/></button>
                    </div>
                )) : <div className="text-center text-slate-400 py-8 text-sm">No entries.</div>}
                <button onClick={() => { setCurrentEntry({ id: Date.now().toString(), title: '', category: '個人成長', rawContent: '', linkedProjectId: '', date: currentMonth.toISOString() }); setIsEditing(true); setNewCat(''); }} className="w-full py-3 border border-dashed border-slate-300 rounded-lg text-slate-400 hover:bg-slate-50 text-sm flex items-center justify-center"><Plus size={16} className="mr-2"/> Add Entry</button>
            </div>
         </div>
      );
    };

    // FAB View
    const FABView = ({ fabList, onUpdateFab, askConfirm }) => {
      const [newFab, setNewFab] = useState({ feature: '', advantage: '', benefit: '', tag: '' });
      const addFab = () => {
          if(!newFab.feature) return;
          onUpdateFab([{ ...newFab, date: new Date().toISOString() }, ...fabList]);
          setNewFab({ feature: '', advantage: '', benefit: '', tag: '' });
      };
      const deleteFab = (idx) => { 
          askConfirm("確定要刪除這條 FAB 優勢嗎？", () => onUpdateFab(fabList.filter((_, i) => i !== idx)));
      };
      const exportMD = () => {
          let md = `| Feature | Advantage | Benefit | Tag |\n|---|---|---|---|\n` + fabList.map(f=>`| ${f.feature} | ${f.advantage} | ${f.benefit} | ${f.tag} |`).join('\n');
          downloadFile(md, 'fab.md');
      };

      return (
         <div className="space-y-6 pb-20 h-full flex flex-col">
            <div className="flex justify-between items-center px-2 pt-2">
                <h2 className="text-xl font-bold text-slate-800">FAB Library</h2>
                <button onClick={exportMD} className="text-slate-400 hover:text-slate-800"><Download size={18}/></button>
            </div>
            <div className="notion-card p-4 mx-2 space-y-3 bg-slate-50 border-l-4 border-amber-400">
               <h3 className="font-bold text-slate-700 flex items-center text-sm"><Zap size={16} className="mr-2 text-amber-500"/>Add New Advantage</h3>
               <input className="notion-input w-full p-2 text-sm" placeholder="Feature (特質)" value={newFab.feature} onChange={e=>setNewFab({...newFab, feature:e.target.value})}/>
               <div className="grid grid-cols-2 gap-2">
                   <input className="notion-input p-2 text-sm" placeholder="Advantage (優勢)" value={newFab.advantage} onChange={e=>setNewFab({...newFab, advantage:e.target.value})}/>
                   <input className="notion-input p-2 text-sm" placeholder="Benefit (效益)" value={newFab.benefit} onChange={e=>setNewFab({...newFab, benefit:e.target.value})}/>
               </div>
               <div className="flex gap-2">
                   <input className="notion-input flex-1 p-2 text-sm" placeholder="Tag" value={newFab.tag} onChange={e=>setNewFab({...newFab, tag:e.target.value})}/>
                   <button onClick={addFab} className="notion-btn bg-amber-100 text-amber-800 hover:bg-amber-200">Add</button>
               </div>
            </div>
            <div className="flex-1 overflow-y-auto px-2 space-y-3 custom-scrollbar">
               {fabList.map((fab, idx) => (
                  <div key={idx} className="notion-card p-4 relative group">
                      <div className="flex justify-between mb-2">
                         <span className="text-xs font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded flex items-center"><Star size={10} className="mr-1"/>{fab.tag || "General"}</span>
                         <span className="text-xs text-slate-300">{new Date(fab.date).toLocaleDateString()}</span>
                      </div>
                      <div className="text-sm space-y-1">
                         <div className="grid grid-cols-[20px_1fr]"><span className="font-bold text-slate-400">F</span> <span className="text-slate-800">{fab.feature}</span></div>
                         <div className="grid grid-cols-[20px_1fr]"><span className="font-bold text-slate-400">A</span> <span className="text-slate-600">{fab.advantage}</span></div>
                         <div className="grid grid-cols-[20px_1fr]"><span className="font-bold text-slate-400">B</span> <span className="font-bold text-slate-800">{fab.benefit}</span></div>
                      </div>
                      <button onClick={() => deleteFab(idx)} className="absolute top-3 right-3 text-slate-200 hover:text-red-400 opacity-0 group-hover:opacity-100 transition p-2"><Trash2 size={16} /></button>
                  </div>
               ))}
            </div>
         </div>
      );
    };

    // Project View
    const ProjectView = ({ projects, onUpdateProjects, categories = [], onUpdateCategories, askConfirm }) => {
       const [newP, setNewP] = useState('');
       const [newPCat, setNewPCat] = useState('');
       const [newPDate, setNewPDate] = useState('');
       const [newPContent, setNewPContent] = useState('');
       const [manageMode, setManageMode] = useState(false);
       const safeCategories = Array.isArray(categories) ? categories : ['Work'];
       
       const addP = () => { 
           if(!newP) return; 
           onUpdateProjects([...projects, { id: Date.now().toString(), title: newP, category: newPCat || 'General', content: newPContent, dueDate: newPDate, status: 'In Progress' }]); 
           if (newPCat && !safeCategories.includes(newPCat)) onUpdateCategories([...safeCategories, newPCat]);
           setNewP(''); setNewPCat(''); setNewPDate(''); setNewPContent('');
       };
       const deleteProject = (id) => { 
           askConfirm("確定要刪除這個專案嗎？", () => onUpdateProjects(projects.filter(p => p.id !== id)));
       };
       const deleteCategory = (cat) => { 
           askConfirm(`刪除分類 ${cat}？`, () => onUpdateCategories(safeCategories.filter(c => c !== cat)));
       };

       return (
          <div className="space-y-6 pb-20">
             <div className="flex justify-between items-center px-2 pt-2">
                <h2 className="text-xl font-bold text-slate-800">Projects</h2>
             </div>
             <div className="notion-card p-4 mx-2 space-y-3">
                 <input value={newP} onChange={e=>setNewP(e.target.value)} className="notion-input w-full p-2 text-sm" placeholder="Project Name..."/>
                 <textarea value={newPContent} onChange={e=>setNewPContent(e.target.value)} className="notion-input w-full p-2 text-sm h-16 resize-none" placeholder="Description..."/>
                 <div className="flex gap-2 relative">
                     <input list="cat-list" value={newPCat} onChange={e=>setNewPCat(e.target.value)} className="notion-input flex-1 p-2 text-sm" placeholder="Category"/>
                     <datalist id="cat-list">{safeCategories.map(c=><option key={c} value={c}/>)}</datalist>
                     <button onClick={()=>setManageMode(!manageMode)} className="text-slate-300 hover:text-slate-600"><Settings size={14}/></button>
                     {manageMode && <div className="absolute top-10 left-0 bg-white border shadow-lg p-2 rounded z-10 w-48">{safeCategories.map(c => <div key={c} className="flex justify-between p-1 hover:bg-slate-50"><span>{c}</span><button onClick={()=>deleteCategory(c)} className="text-red-400">x</button></div>)}</div>}
                 </div>
                 <div className="flex gap-2">
                     <input type="date" value={newPDate} onChange={e=>setNewPDate(e.target.value)} className="notion-input p-2 text-sm text-slate-500"/>
                     <button onClick={addP} className="notion-btn notion-btn-primary flex-1">Add Project</button>
                 </div>
             </div>
             <div className="space-y-2 px-2">
                {projects.map(p => (
                   <div key={p.id} className="notion-card p-3">
                      <div className="flex justify-between items-start">
                          <div>
                              <div className="font-bold text-slate-700">{p.title}</div>
                              <div className="text-xs text-slate-500 mt-1">{p.content}</div>
                              <div className="flex gap-2 mt-2">
                                  <span className="text-[10px] text-slate-400 bg-slate-50 px-1.5 rounded">{p.category}</span>
                                  {p.dueDate && <span className="text-[10px] text-slate-400 flex items-center"><Clock size={10} className="mr-1"/>{p.dueDate}</span>}
                              </div>
                          </div>
                          <div className="flex items-center gap-2">
                              <button onClick={() => onUpdateProjects(projects.map(pr => pr.id === p.id ? {...pr, status: pr.status === 'Done' ? 'In Progress' : 'Done'} : pr))} className={`text-xs font-bold px-2 py-1 rounded ${p.status === 'Done' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>{p.status === 'Done' ? 'Done' : 'Active'}</button>
                              <button onClick={() => deleteProject(p.id)} className="text-slate-300 hover:text-red-400"><Trash2 size={16}/></button>
                          </div>
                      </div>
                   </div>
                ))}
             </div>
          </div>
       );
    };

    // Idea View (Fixed: Custom Categories)
    const IdeaView = ({ ideas, onUpdateIdeas, askConfirm, categories = [], onUpdateCategories }) => {
          const [title, setTitle] = useState('');
          const [content, setContent] = useState('');
          const [sourceUrl, setSourceUrl] = useState('');
          const [category, setCategory] = useState('');
          const [manageMode, setManageMode] = useState(false);
          
          const safeCategories = Array.isArray(categories) ? categories : ['突發奇想', '網頁文章', 'Youtube影片', '書籍摘錄', '社群貼文'];

          const addIdea = () => { 
              if(!content.trim() && !title.trim()) return; 
              const finalCat = category || '靈感';
              if (category && !safeCategories.includes(category)) onUpdateCategories([...safeCategories, category]);
              onUpdateIdeas([{ 
                  id: Date.now().toString(), 
                  title: title || '未命名靈感', 
                  content, 
                  sourceUrl,
                  category: finalCat,
                  date: new Date().toISOString() 
              }, ...ideas]); 
              setTitle(''); setContent(''); setSourceUrl(''); setCategory('');
          };
          
          const deleteIdea = (id) => { 
              askConfirm("確定要刪除這條靈感嗎？", () => onUpdateIdeas(ideas.filter(i => i.id !== id)));
          };
          
          const deleteCategory = (cat) => { 
              askConfirm(`刪除分類 ${cat}？`, () => onUpdateCategories(safeCategories.filter(c => c !== cat)));
          };

          return (
            <div className="space-y-4 pb-20 h-full flex flex-col">
                <div className="flex justify-between items-center px-1">
                    <h2 className="text-xl font-bold">靈感捕捉</h2>
                </div>
                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mx-1 space-y-3">
                    <input value={title} onChange={e=>setTitle(e.target.value)} className="w-full font-bold text-sm outline-none placeholder-slate-300" placeholder="標題 (選填)"/>
                    <textarea value={content} onChange={e=>setContent(e.target.value)} className="w-full text-sm resize-none outline-none h-16 placeholder-slate-300" placeholder="捕捉想法..."/>
                    
                    <div className="grid grid-cols-2 gap-2">
                        <div className="relative flex items-center">
                            <input list="idea-cat-list" value={category} onChange={e=>setCategory(e.target.value)} className="w-full bg-slate-50 text-xs p-2 rounded border border-slate-100 text-slate-600 outline-none" placeholder="選擇或新增分類..."/>
                            <datalist id="idea-cat-list">{safeCategories.map(s => <option key={s} value={s}>{s}</option>)}</datalist>
                            <button onClick={()=>setManageMode(!manageMode)} className="absolute right-2 text-slate-300 hover:text-slate-600"><Settings size={12}/></button>
                            {manageMode && <div className="absolute top-8 left-0 bg-white border shadow-lg p-2 rounded z-10 w-48">{safeCategories.map(c => <div key={c} className="flex justify-between p-1 hover:bg-slate-50 text-xs"><span>{c}</span><button onClick={()=>deleteCategory(c)} className="text-red-400">x</button></div>)}</div>}
                        </div>
                        <div className="flex items-center bg-slate-50 rounded border border-slate-100 px-2">
                            <Link size={12} className="text-slate-400 mr-1 min-w-[12px]"/>
                            <input value={sourceUrl} onChange={e=>setSourceUrl(e.target.value)} className="bg-transparent text-xs w-full outline-none placeholder-slate-400" placeholder="貼上來源網址..."/>
                        </div>
                    </div>

                    <div className="flex justify-end">
                        <button onClick={addIdea} className="notion-btn notion-btn-primary text-xs px-4 py-1.5 rounded-full">Save Idea</button>
                    </div>
                </div>
                <div className="grid grid-cols-2 gap-2 px-1 overflow-y-auto custom-scrollbar">
                    {ideas.map(i => (
                        <div key={i.id} className="notion-card p-3 flex flex-col relative group h-auto min-h-[140px]">
                            <div className="flex justify-between items-start mb-1">
                                <span className="text-[10px] bg-slate-100 text-slate-500 px-1.5 rounded">{i.category || '靈感'}</span>
                                {i.sourceUrl && <a href={i.sourceUrl} target="_blank" rel="noreferrer" className="text-indigo-400 hover:text-indigo-600"><Globe size={12}/></a>}
                            </div>
                            <h4 className="font-bold text-sm mb-1 truncate">{i.title}</h4>
                            <p className="text-xs text-slate-600 whitespace-pre-wrap overflow-hidden flex-1 line-clamp-4">{i.content}</p>
                            <button onClick={()=>deleteIdea(i.id)} className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-400 transition bg-white rounded-full p-1 shadow-sm"><Trash2 size={14}/></button>
                        </div>
                    ))}
                </div>
            </div>
          );
    };

    const App = () => {
      const [activeTab, setActiveTab] = useState(AppTab.FINANCE);
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
      const [isSyncing, setIsSyncing] = useState(false);
      const [isSettingsOpen, setIsSettingsOpen] = useState(false);
      const [syncStatus, setSyncStatus] = useState('');
      const [isInitialized, setIsInitialized] = useState(false);
      
      // Modal State
      const [confirmModal, setConfirmModal] = useState({ isOpen: false, message: '', onConfirm: null });
      
      // Data States
      const [entries, setEntries] = useState([]);
      const [projects, setProjects] = useState([]);
      const [categories, setCategories] = useState(['Work', 'Health', 'Learning']);
      const [journalCategories, setJournalCategories] = useState(['個人成長', '工作職涯', '健康生活', '財務管理', '人際關係']);
      const [ideaCategories, setIdeaCategories] = useState(['突發奇想', '網頁文章', 'Youtube影片', '書籍摘錄', '社群貼文']);
      const [financeData, setFinanceData] = useState([]);
      const [fabList, setFabList] = useState([]);
      const [todos, setTodos] = useState([]);
      const [ideas, setIdeas] = useState([]);
      const [dataTimestamp, setDataTimestamp] = useState(0);

      const askConfirm = (message, onConfirmAction) => {
          setConfirmModal({
              isOpen: true,
              message,
              onConfirm: () => {
                  onConfirmAction();
                  setConfirmModal({ isOpen: false, message: '', onConfirm: null });
              }
          });
      };

      // Sync & Auto Clean
      const syncData = async (forcePull = false) => {
          setIsSyncing(true); setSyncStatus('Syncing...');
          try {
             const localRaw = localStorage.getItem('lc_data');
             const localData = localRaw ? JSON.parse(localRaw) : {};
             const localTS = localData.dataTimestamp || 0;

             if (!isInitialized) {
                 if(localData.entries) setEntries(localData.entries);
                 if(localData.projects) setProjects(localData.projects);
                 if(localData.categories) setCategories(localData.categories);
                 if(localData.journalCategories) setJournalCategories(localData.journalCategories);
                 if(localData.ideaCategories) setIdeaCategories(localData.ideaCategories);
                 if(localData.fabList) setFabList(localData.fabList);
                 if(localData.todos) setTodos(localData.todos);
                 if(localData.ideas) setIdeas(localData.ideas);
                 
                 // Auto Clean logic: Filter out 2025/11 if exists locally
                 let fData = localData.financeData;
                 if(!fData || fData.length === 0) fData = parseAssetData(INITIAL_RAW_ASSET_DATA);
                 
                 // Clean: Remove "Nov-25" or "2025-11"
                 const cleanedFData = fData.filter(d => d.rawDate !== 'Nov-25' && d.date !== '2025-11-01');
                 setFinanceData(cleanedFData);
                 
                 setDataTimestamp(localTS);
             }

             const res = await fetch(GAS_API_URL);
             const cloudData = await res.json();
             const cloudTS = cloudData.dataTimestamp || 0;

             if (cloudTS > localTS || forcePull) {
                 if(cloudData.entries) setEntries(cloudData.entries);
                 if(cloudData.projects) setProjects(cloudData.projects);
                 if(cloudData.categories) setCategories(cloudData.categories);
                 if(cloudData.journalCategories) setJournalCategories(cloudData.journalCategories);
                 if(cloudData.ideaCategories) setIdeaCategories(cloudData.ideaCategories);
                 if(cloudData.fabList) setFabList(cloudData.fabList);
                 if(cloudData.todos) setTodos(cloudData.todos);
                 if(cloudData.ideas) setIdeas(cloudData.ideas);
                 
                 // Clean Cloud Data on load as well
                 if(cloudData.financeData) {
                     const cleanCloudF = cloudData.financeData.filter(d => d.rawDate !== 'Nov-25' && d.date !== '2025-11-01');
                     setFinanceData(cleanCloudF);
                 }
                 
                 setDataTimestamp(cloudTS);
                 localStorage.setItem('lc_data', JSON.stringify(cloudData));
                 setSyncStatus('Updated');
                 if(forcePull) alert("Synced from cloud.");
             } else { setSyncStatus('Ready'); }
          } catch (e) { console.error(e); setSyncStatus('Offline'); } 
          finally { setIsSyncing(false); setIsInitialized(true); }
      };

      useEffect(() => { syncData(); document.addEventListener("visibilitychange", () => document.visibilityState==='visible' && syncData()); }, []);

      useEffect(() => {
         if (!isInitialized) return;
         const timer = setTimeout(async () => {
            const newTS = Date.now();
            const payload = { entries, projects, categories, journalCategories, ideaCategories, financeData, fabList, todos, ideas, dataTimestamp: newTS };
            localStorage.setItem('lc_data', JSON.stringify(payload));
            setDataTimestamp(newTS);
            setIsSyncing(true); setSyncStatus('Saving...');
            try { await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) }); setSyncStatus('Saved'); } 
            catch(e) { setSyncStatus('Local Only'); } 
            finally { setIsSyncing(false); }
         }, 3000);
         return () => clearTimeout(timer);
      }, [entries, projects, categories, journalCategories, ideaCategories, financeData, fabList, todos, ideas, isInitialized]);

      const handleForcePush = async () => {
          askConfirm("確定要用「目前這台裝置」的資料覆蓋雲端嗎？", async () => {
              setIsSyncing(true);
              const newTS = Date.now();
              const payload = { entries, projects, categories, journalCategories, ideaCategories, financeData, fabList, todos, ideas, dataTimestamp: newTS };
              try {
                  localStorage.setItem('lc_data', JSON.stringify(payload));
                  await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                  alert("雲端已更新！");
              } catch(e) { alert("上傳失敗"); } finally { setIsSyncing(false); }
          });
      };
      
      const handleExport = () => {
          const data = { entries, projects, financeData, fabList, todos, ideas, dataTimestamp: Date.now() };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = `backup.json`; document.body.appendChild(a); a.click();
      };
      
      const handleImport = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (event) => {
              try {
                  const data = JSON.parse(event.target.result);
                  askConfirm("確定要還原備份嗎？這將覆蓋現有資料。", () => {
                      if(data.entries) setEntries(data.entries);
                      if(data.projects) setProjects(data.projects);
                      if(data.financeData) setFinanceData(data.financeData);
                      if(data.fabList) setFabList(data.fabList);
                      if(data.todos) setTodos(data.todos);
                      if(data.ideas) setIdeas(data.ideas);
                      alert("還原成功！");
                  });
              } catch(err) { alert("格式錯誤"); }
          };
          reader.readAsText(file);
      };

      const renderContent = () => {
         switch(activeTab) {
            case AppTab.HOME: return <HomeView onNavigate={setActiveTab} />;
            case AppTab.TODO: return <TodoView todos={todos} onUpdateTodos={setTodos} askConfirm={askConfirm} />;
            case AppTab.IDEAS: return <IdeaView ideas={ideas} onUpdateIdeas={setIdeas} askConfirm={askConfirm} categories={ideaCategories} onUpdateCategories={setIdeaCategories} />;
            case AppTab.JOURNAL: return <JournalView entries={entries} projects={projects} onUpdateEntries={setEntries} apiKey={apiKey} categories={journalCategories} onUpdateCategories={setJournalCategories} askConfirm={askConfirm} />;
            case AppTab.PROJECTS: return <ProjectView projects={projects} onUpdateProjects={setProjects} categories={categories} onUpdateCategories={setCategories} askConfirm={askConfirm} />;
            case AppTab.CALENDAR: return <CalendarView todos={todos} projects={projects} />;
            case AppTab.FINANCE: return <FinanceView data={financeData} onAddData={(d) => setFinanceData([...financeData, d].sort((a,b)=>new Date(a.date)-new Date(b.date)))} onDeleteData={(idx) => setFinanceData(financeData.filter((_, i) => i !== idx))} askConfirm={askConfirm} />;
            case AppTab.FAB: return <FABView fabList={fabList} onUpdateFab={setFabList} askConfirm={askConfirm} />;
            default: return null;
         }
      };

      return (
        <div className="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative overflow-hidden flex flex-col border-x border-slate-200">
           
           <ConfirmModal 
              isOpen={confirmModal.isOpen} 
              message={confirmModal.message} 
              onConfirm={confirmModal.onConfirm} 
              onCancel={() => setConfirmModal({ ...confirmModal, isOpen: false })}
           />

           {isSettingsOpen && (
              <div className="fixed inset-0 bg-black/20 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                 <div className="bg-white rounded-xl p-6 w-full max-w-sm space-y-4 shadow-2xl">
                    <div className="flex justify-between items-center"><h3 className="font-bold text-lg">Settings</h3><button onClick={()=>setIsSettingsOpen(false)}>✕</button></div>
                    <div className="grid grid-cols-2 gap-3">
                        <button onClick={()=>syncData(true)} className="notion-btn bg-indigo-50 text-indigo-700 border border-indigo-200 flex flex-col h-20 items-center justify-center"><CloudDownload size={20} className="mb-1"/>Force Pull</button>
                        <button onClick={handleForcePush} className="notion-btn bg-white border border-red-200 text-red-600 flex flex-col h-20 items-center justify-center"><CloudUpload size={20} className="mb-1"/>Force Push</button>
                        <button onClick={handleExport} className="notion-btn bg-slate-50 border flex flex-col h-20 items-center justify-center"><Download size={20} className="mb-1"/>Export JSON</button>
                        <label className="notion-btn bg-slate-50 border flex flex-col h-20 items-center justify-center cursor-pointer"><Upload size={20} className="mb-1"/>Import JSON<input type="file" className="hidden" onChange={handleImport}/></label>
                    </div>
                    <input type="password" placeholder="API Key" value={apiKey} onChange={e=>{setApiKey(e.target.value); localStorage.setItem('gemini_api_key', e.target.value)}} className="notion-input w-full p-2 text-sm bg-slate-50"/>
                 </div>
              </div>
           )}

           <header className="bg-white/90 backdrop-blur px-4 h-12 flex items-center justify-between border-b border-slate-100 sticky top-0 z-30">
              <div onClick={() => setActiveTab(AppTab.HOME)} className="font-bold text-slate-800 flex items-center cursor-pointer hover:bg-slate-50 p-1 rounded transition"><Compass className="mr-2 text-slate-800" size={20}/> LifeOS 3.8</div>
              <div className="flex items-center gap-3">
                 <div className="text-[10px] font-medium text-slate-400 flex items-center">
                    {isSyncing ? <RefreshCw size={10} className="animate-spin mr-1"/> : <Cloud size={10} className={`mr-1 ${syncStatus.includes('Offline') ? 'text-red-400' : 'text-green-500'}`}/>}
                    {syncStatus}
                 </div>
                 <button onClick={()=>setIsSettingsOpen(true)}><Settings size={18} className="text-slate-400 hover:text-slate-800"/></button>
              </div>
           </header>

           <main className="flex-1 p-3 overflow-y-auto custom-scrollbar">{renderContent()}</main>

           <nav className="bg-white border-t border-slate-100 p-2 flex justify-around pb-safe sticky bottom-0 z-30">
              {[
                 {id: AppTab.JOURNAL, icon: BookOpen, label: '覆盤'},
                 {id: AppTab.PROJECTS, icon: Target, label: '專案'},
                 {id: AppTab.CALENDAR, icon: Calendar, label: '日曆'},
                 {id: AppTab.FINANCE, icon: TrendingUp, label: '資產'}
              ].map(t => (
                 <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`flex flex-col items-center p-2 rounded-lg transition ${activeTab===t.id ? 'text-slate-900 bg-slate-100' : 'text-slate-400 hover:text-slate-600'}`}>
                    <t.icon size={20} strokeWidth={activeTab===t.id ? 2 : 1.5}/>
                    <span className="text-[10px] font-medium mt-1">{t.label}</span>
                 </button>
              ))}
           </nav>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
