<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Life Compass v2.6 (SyncMaster)</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#f8fafc">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>window.process = { env: { NODE_ENV: 'production' } };</script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script crossorigin src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Inter:wght@400;600;800&display=swap');
    body { font-family: 'Noto Sans TC', 'Inter', sans-serif; background-color: #f8fafc; height: 100vh; overflow-y: auto; overscroll-behavior-y: none; }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // Google Apps Script 網址
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbx4S4xt6GsA_Ffdayxg6xHC3wfiKJGdHO8I9hXciCLD27_wCAXgo5TCrYb4a5qSn-K8mQ/exec";

    const { useState, useEffect, useMemo, useRef } = React;
    const { createRoot } = ReactDOM;
    const { AreaChart, Area, XAxis, Tooltip, ResponsiveContainer, Bar, ComposedChart, Line } = window.Recharts || {};

    // --- Icons ---
    const IconBase = ({ children, size = 20, className = "", ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
    );
    const Icons = {
      Compass: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></IconBase>,
      BookOpen: (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>,
      Target: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>,
      TrendingUp: (p) => <IconBase {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>,
      Zap: (p) => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>,
      Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
      Sparkles: (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3z"/></IconBase>,
      Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
      Settings: (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>,
      Cloud: (p) => <IconBase {...p}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19h-2c-2.485 0-4.5-2.015-4.5-4.5S2.015 10 4.5 10c.174 0 .343.02.51.054C5.83 6.934 8.668 5 11.5 5c4.006 0 7.454 2.816 8.275 6.655 2.484.205 4.225 2.216 4.225 4.845C24 19.015 21.985 21 19.5 21h-2z"/></IconBase>,
      RefreshCw: (p) => <IconBase {...p}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconBase>,
      Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
      Link: (p) => <IconBase {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconBase>,
      Star: (p) => <IconBase {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>,
      Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
      Upload: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>,
      CloudUpload: (p) => <IconBase {...p}><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19h-2c-2.485 0-4.5-2.015-4.5-4.5S2.015 10 4.5 10c.174 0 .343.02.51.054C5.83 6.934 8.668 5 11.5 5c4.006 0 7.454 2.816 8.275 6.655 2.484.205 4.225 2.216 4.225 4.845C24 19.015 21.985 21 19.5 21h-2z"/></IconBase>,
      Clock: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>
    };
    const { Compass, BookOpen, Target, TrendingUp, Zap, Save, Sparkles, Trash2, Calendar, ChevronRight, Settings, Cloud, RefreshCw, Plus, Link, Star, Download, Upload, CloudUpload, Clock } = Icons;

    const AppTab = { JOURNAL: 'journal', PROJECTS: 'projects', FINANCE: 'finance', COMPASS: 'compass', FAB: 'fab' };
    
    // 預設資產資料 (2020-2025/10)
    const INITIAL_RAW_ASSET_DATA = `
    Dec-20 56 26 46% 30 0 0% 56.0 54% 47.6 6.20 6.2 6.20
    Mar-21 77 41 53% 35 0 0% 77.0 45% 65.4 3.30 3.3 9.50
    Jul-21 101.4 38.7 38% 62.7 0 0% 101.4 62% 98.1 4.10 0.30 10.30
    Dec-21 115.3 59.3 51% 56 0 0% 115.3 49% 125.2 5.10 0.30 11.30
    Jun-22 135.6 56.2 51.2 41% 84.4 0 0% 135.6 62% 178.5 (12.02) (2.30) (0.72)
    Dec-22 151.0 87.9 79.9 53% 71.1 0 0% 151.0 47% 212.7 (18.31) (6.00) (7.01)
    Jun-23 317 130.6 151.7 48% 165.3 96.9 31% 0% 220.1 52% 267.6 31.30 19.60 24.29
    Dec-23 337.4 165.6 193.0 57% 144.4 87.5 26% 0% 249.9 43% 303.1 39.60 8.10 32.59
    Jun-24 483.5 233.2 326.2 67% 157.3 124.3 26% 0% 359.2 33% 356.6 74.59 27.00 107.18
    Dec-24 526.6 241 338.1 64% 73.5 115.1 22% 115 22% 411.5 14% 392 88.70 5.19 121.29
    Oct-25 587.1 205.2 291.7 50% 94.4 127.1 22% 201 34% 460.0 16% 431.3 15.18 24.80 136.47
    `;

    // XIRR Utility
    function calculateXIRR_Newton(transactions, guess = 0.1) {
      if (transactions.length < 2) return 0;
      const d0 = transactions[0].date;
      const func = (r) => transactions.reduce((sum, t) => sum + t.amount / Math.pow(1 + r, (t.date - d0) / (1000 * 60 * 60 * 24 * 365)), 0);
      const deriv = (r) => transactions.reduce((sum, t) => {
          const days = (t.date - d0) / (1000 * 60 * 60 * 24 * 365);
          return sum - days * t.amount / Math.pow(1 + r, days + 1);
      }, 0);
      let r = guess;
      for (let i = 0; i < 50; i++) {
          const f = func(r);
          const df = deriv(r);
          if (Math.abs(f) < 0.0001) return r;
          if (df === 0) return r;
          r = r - f / df;
      }
      return r;
    }

    function parseAssetData(rawText) {
       const lines = rawText.trim().split('\n');
       return lines.map(line => {
           if (!line.trim()) return null;
           const tokens = line.trim().split(/[ \t]+/);
           const dateStr = tokens[0];
           const parts = dateStr.split('-');
           const monthMap = { 'Jan':'01','Feb':'02','Mar':'03','Apr':'04','May':'05','Jun':'06','Jul':'07','Aug':'08','Sep':'09','Oct':'10','Nov':'11','Dec':'12' };
           const date = `20${parts[1]}-${monthMap[parts[0]] || '01'}-01`;
           const percIndices = [];
           tokens.forEach((t, idx) => { if (t.includes('%')) percIndices.push(idx); });
           let total = parseFloat(tokens[1].replace(/,/g, ''));
           let principal = parseFloat(tokens[2].replace(/,/g, ''));
           let invBook = 0;
           if (percIndices[0] > 3) invBook = parseFloat(tokens[3].replace(/,/g, ''));
           let pool = [];
           for (let i = percIndices[0] + 1; i < percIndices[percIndices.length - 1] - 1; i++) {
               let t = tokens[i];
               if (t.includes('%')) continue;
               let val = parseFloat(t.replace(/,/g, ''));
               if (!isNaN(val)) pool.push(val);
           }
           let cash = 0, loan = 0, house = 0;
           if (pool.length === 3) { cash = pool[0]; loan = pool[1]; house = pool[2]; }
           else if (pool.length === 2) { cash = pool[0]; loan = pool[1]; house = 0; }
           else if (pool.length === 1) { cash = pool[0]; loan = 0; house = 0; }
           if (!invBook) invBook = total - cash - house;
           let netAssetsToken = tokens[percIndices[percIndices.length - 1] - 1];
           let netAssets = parseFloat(netAssetsToken.replace(/,/g, ''));
           let calculatedLoan = total - netAssets;
           if (Math.abs(calculatedLoan - loan) > 5) loan = Math.max(0, calculatedLoan);
           return { rawDate: dateStr, date, total, principal, netAssets, loan, house, cash, invBook };
       }).filter(x => x !== null).sort((a,b) => new Date(a.date) - new Date(b.date));
    }

    // --- Components ---

    const FinanceView = ({ data, onAddData, onResetData }) => {
      const [newData, setNewData] = useState({ date: new Date().toISOString().slice(0,7), principal: '', inv: '', cash: '', house: '', loan: '' });
      const [showForm, setShowForm] = useState(false);

      const annualXIRR = useMemo(() => {
        if (data.length === 0) return [];
        const years = [...new Set(data.map(d => d.date.substring(0, 4)))].sort().filter(y => parseInt(y) >= 2021);
        return years.map(year => {
          const prevData = data.find(d => d.date.startsWith(`${parseInt(year)-1}-12`)) || data.find(d => d.date.startsWith(`${parseInt(year)-1}-`));
          const currData = data.filter(d => d.date.startsWith(`${year}-`));
          if (!prevData || currData.length === 0) return null;
          let trans = [{ amount: -prevData.netAssets, date: new Date(`${year}-01-01`) }];
          let prevPrin = prevData.principal;
          currData.forEach(r => {
             const diff = r.principal - prevPrin;
             if (Math.abs(diff) > 0.01) trans.push({ amount: -diff, date: new Date(r.date) });
             prevPrin = r.principal;
          });
          trans.push({ amount: currData[currData.length-1].netAssets, date: new Date(currData[currData.length-1].date) });
          return { year, val: calculateXIRR_Newton(trans) * 100 };
        }).filter(Boolean);
      }, [data]);

      const handleSubmit = () => {
         const total = parseFloat(newData.inv) + parseFloat(newData.cash) + parseFloat(newData.house);
         const net = total - parseFloat(newData.loan);
         const entry = {
            rawDate: newData.date,
            date: newData.date + "-01",
            total, principal: parseFloat(newData.principal), netAssets: net,
            invBook: parseFloat(newData.inv), cash: parseFloat(newData.cash), house: parseFloat(newData.house), loan: parseFloat(newData.loan)
         };
         onAddData(entry);
         setShowForm(false);
      };

      return (
        <div className="space-y-6 pb-20">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-black text-slate-900 flex items-center"><TrendingUp className="mr-2 text-indigo-600"/>資產戰情室</h2>
            <div className="flex gap-2">
                <button onClick={onResetData} className="bg-slate-200 text-slate-600 px-3 py-2 rounded-lg text-xs font-bold" title="強制匯入內建預設數據">
                    <Download size={14}/>
                </button>
                <button onClick={() => setShowForm(!showForm)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow">
                    {showForm ? "取消" : "+ 紀錄"}
                </button>
            </div>
          </div>
          <div className="grid grid-cols-3 gap-2">
            {annualXIRR.slice(-6).map(i => (
              <div key={i.year} className="bg-white p-3 rounded-xl border border-slate-100 text-center shadow-sm">
                <div className="text-xs text-slate-500 font-bold">{i.year} IRR</div>
                <div className={`text-lg font-black ${i.val >= 0 ? 'text-indigo-600' : 'text-slate-400'}`}>{i.val.toFixed(1)}%</div>
              </div>
            ))}
          </div>
          {showForm && (
            <div className="bg-white p-4 rounded-xl border-l-4 border-indigo-500 shadow-lg space-y-4 animate-pulse-subtle">
               <div className="grid grid-cols-2 gap-3">
                  <input type="month" value={newData.date} onChange={e=>setNewData({...newData, date:e.target.value})} className="p-2 border rounded text-sm"/>
                  <input type="number" placeholder="投入本金" value={newData.principal} onChange={e=>setNewData({...newData, principal:e.target.value})} className="p-2 border rounded text-sm"/>
               </div>
               <div className="grid grid-cols-3 gap-2">
                  <input type="number" placeholder="投資" value={newData.inv} onChange={e=>setNewData({...newData, inv:e.target.value})} className="p-2 border rounded text-sm"/>
                  <input type="number" placeholder="現金" value={newData.cash} onChange={e=>setNewData({...newData, cash:e.target.value})} className="p-2 border rounded text-sm"/>
                  <input type="number" placeholder="房產" value={newData.house} onChange={e=>setNewData({...newData, house:e.target.value})} className="p-2 border rounded text-sm"/>
               </div>
               <input type="number" placeholder="負債/貸款" value={newData.loan} onChange={e=>setNewData({...newData, loan:e.target.value})} className="w-full p-2 border rounded text-sm"/>
               <button onClick={handleSubmit} className="w-full bg-slate-800 text-white py-2 rounded font-bold">確認更新</button>
            </div>
          )}
          <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm h-72">
             <div className="text-sm font-bold text-slate-700 mb-2">淨資產堆疊圖</div>
             <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={data}>
                   <defs>
                      <linearGradient id="colorNet" x1="0" y1="0" x2="0" y2="1">
                         <stop offset="5%" stopColor="#4f46e5" stopOpacity={0.8}/>
                         <stop offset="95%" stopColor="#4f46e5" stopOpacity={0}/>
                      </linearGradient>
                   </defs>
                   <XAxis dataKey="rawDate" hide/>
                   <Tooltip />
                   <Area type="monotone" dataKey="netAssets" stroke="#4f46e5" fillOpacity={1} fill="url(#colorNet)" />
                   <Area type="monotone" dataKey="principal" stroke="#cbd5e1" fill="transparent" strokeDasharray="3 3"/>
                </AreaChart>
             </ResponsiveContainer>
          </div>
          <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm h-64">
             <div className="text-sm font-bold text-slate-700 mb-2">資產配置與負債</div>
             <ResponsiveContainer width="100%" height="100%">
                <ComposedChart data={data.slice(-12)}>
                   <XAxis dataKey="rawDate" tick={{fontSize:10}}/>
                   <Tooltip />
                   <Bar dataKey="loan" fill="#cbd5e1" stackId="a" />
                   <Bar dataKey="netAssets" fill="#3b82f6" stackId="a" />
                   <Line type="monotone" dataKey="total" stroke="#1e293b" strokeWidth={2} />
                </ComposedChart>
             </ResponsiveContainer>
          </div>
        </div>
      );
    };

    const JournalView = ({ entries, projects, onUpdateEntries, apiKey, fabList, onAddFab }) => {
      const [isEditing, setIsEditing] = useState(false);
      const [currentEntry, setCurrentEntry] = useState({ id: '', title: '', category: '個人成長', rawContent: '', linkedProjectId: '' });
      const [manualFab, setManualFab] = useState({ feature: '', advantage: '', benefit: '', tag: '' });
      const [isAnalyzing, setIsAnalyzing] = useState(false);

      const activeProjects = useMemo(() => projects.filter(p => p.status !== 'Done'), [projects]);
      const CATEGORIES = ['個人成長', '工作職涯', '健康生活', '財務管理', '人際關係', 'FAB 亮點'];

      const handleAnalyze = async () => {
        if (!currentEntry.rawContent.trim() || !apiKey) return alert("請輸入內容並確認 API Key");
        setIsAnalyzing(true);
        try {
           const projectContext = currentEntry.linkedProjectId ? `關聯專案: ${projects.find(p=>p.id === currentEntry.linkedProjectId)?.title}` : "無特定專案";
           const prompt = `你是一位人生教練。請分析這篇週記。\n類型：${currentEntry.category}\n標題：${currentEntry.title}\n${projectContext}\n內容：${currentEntry.rawContent}\n請回傳 JSON：\n{ "summary": "50字摘要", "fab": { "feature": "", "advantage": "", "benefit": "", "tag": "" } }`;
           const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
           const json = await res.json();
           const result = JSON.parse(json.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
           if (result.fab && result.fab.feature) setManualFab(result.fab);
           setCurrentEntry(prev => ({ ...prev, parsedAnalysis: result }));
        } catch (e) { console.error(e); alert("AI 分析失敗"); } finally { setIsAnalyzing(false); }
      };

      const saveEntry = () => {
        const updated = { ...currentEntry, date: currentEntry.date || new Date().toISOString() };
        const exists = entries.find(e => e.id === updated.id);
        onUpdateEntries(exists ? entries.map(e => e.id === updated.id ? updated : e) : [updated, ...entries]);
        if (manualFab.feature.trim()) onAddFab({ ...manualFab, date: updated.date, sourceId: updated.id });
        setIsEditing(false);
        setManualFab({ feature: '', advantage: '', benefit: '', tag: '' });
      };

      const deleteEntry = (e, id) => {
          e.stopPropagation();
          if(confirm("確定要刪除這篇週記嗎？")) {
              onUpdateEntries(entries.filter(entry => entry.id !== id));
          }
      };

      if (isEditing) {
        return (
          <div className="bg-white h-[calc(100vh-140px)] flex flex-col rounded-xl shadow-sm border border-slate-200">
             <div className="p-4 border-b bg-slate-50 flex justify-between items-center rounded-t-xl">
                <button onClick={() => setIsEditing(false)} className="text-slate-500">取消</button>
                <span className="font-bold text-slate-700">編輯週記</span>
                <button onClick={saveEntry} className="text-indigo-600 font-bold flex items-center"><Save size={18} className="mr-1"/>儲存</button>
             </div>
             <div className="flex-1 overflow-y-auto p-4 space-y-4">
                <input className="w-full text-lg font-bold placeholder-slate-300 border-b border-slate-100 pb-2 outline-none" placeholder="輸入標題..." value={currentEntry.title} onChange={e=>setCurrentEntry({...currentEntry, title:e.target.value})}/>
                <div className="grid grid-cols-2 gap-4">
                   <div>
                      <label className="text-xs font-bold text-slate-400 block mb-1">分類</label>
                      <select className="w-full bg-slate-50 rounded p-2 text-sm" value={currentEntry.category} onChange={e=>setCurrentEntry({...currentEntry, category:e.target.value})}>
                         {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                      </select>
                   </div>
                   <div>
                      <label className="text-xs font-bold text-slate-400 block mb-1">關聯專案</label>
                      <select className="w-full bg-slate-50 rounded p-2 text-sm" value={currentEntry.linkedProjectId} onChange={e=>setCurrentEntry({...currentEntry, linkedProjectId:e.target.value})}>
                         <option value="">無關聯</option>
                         {activeProjects.map(p => <option key={p.id} value={p.id}>{p.title}</option>)}
                      </select>
                   </div>
                </div>
                <div>
                   <label className="text-xs font-bold text-slate-400 block mb-1">內容</label>
                   <textarea className="w-full h-32 p-3 bg-slate-50 rounded-xl border border-slate-200 resize-none text-sm leading-relaxed" value={currentEntry.rawContent} onChange={e=>setCurrentEntry({...currentEntry, rawContent:e.target.value})} placeholder="紀錄你的成就、困難與反思..."></textarea>
                </div>
                <div className="border border-amber-200 rounded-xl p-3 bg-amber-50/50">
                   <div className="flex items-center justify-between mb-2">
                      <h4 className="text-sm font-bold text-amber-700 flex items-center"><Zap size={14} className="mr-1"/>✨ FAB 優勢萃取 (選填)</h4>
                      <span className="text-[10px] text-amber-600 bg-amber-100 px-2 rounded-full">同步至優勢庫</span>
                   </div>
                   <div className="space-y-2">
                      <input className="w-full p-2 text-sm border border-amber-100 rounded bg-white" placeholder="F (Feature)" value={manualFab.feature} onChange={e=>setManualFab({...manualFab, feature:e.target.value})} />
                      <input className="w-full p-2 text-sm border border-amber-100 rounded bg-white" placeholder="A (Advantage)" value={manualFab.advantage} onChange={e=>setManualFab({...manualFab, advantage:e.target.value})} />
                      <input className="w-full p-2 text-sm border border-amber-100 rounded bg-white" placeholder="B (Benefit)" value={manualFab.benefit} onChange={e=>setManualFab({...manualFab, benefit:e.target.value})} />
                      <input className="w-full p-2 text-sm border border-amber-100 rounded bg-white" placeholder="Tag (標籤)" value={manualFab.tag} onChange={e=>setManualFab({...manualFab, tag:e.target.value})} />
                   </div>
                </div>
                <button onClick={handleAnalyze} disabled={isAnalyzing} className="w-full py-3 bg-gradient-to-r from-amber-400 to-orange-500 text-white rounded-xl font-bold shadow-md flex justify-center items-center">
                      {isAnalyzing ? "AI 思考中..." : <><Sparkles size={20} className="mr-2"/>產生 AI 覆盤報告</>}
                </button>
                {currentEntry.parsedAnalysis && (
                   <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 space-y-2">
                      <div className="font-bold text-indigo-900 text-sm">AI 洞察</div>
                      <p className="text-sm text-indigo-800">{currentEntry.parsedAnalysis.summary}</p>
                   </div>
                )}
             </div>
          </div>
        );
      }

      return (
         <div className="space-y-4 pb-24">
            <div className="flex justify-between items-center">
               <h2 className="text-2xl font-black text-slate-900">每週覆盤</h2>
               <button onClick={() => { setCurrentEntry({ id: Date.now().toString(), title: '', category: '個人成長', rawContent: '', linkedProjectId: '' }); setManualFab({feature:'',advantage:'',benefit:'',tag:''}); setIsEditing(true); }} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow flex items-center"><Plus size={16} className="mr-1"/>新增</button>
            </div>
            <div className="grid gap-4">
               {entries.map(e => (
                  <div key={e.id} onClick={() => { setCurrentEntry(e); setManualFab({feature:'',advantage:'',benefit:'',tag:''}); setIsEditing(true); }} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition cursor-pointer relative group">
                     <div className="flex justify-between items-start mb-2">
                        <span className="text-xs font-bold text-slate-400">{new Date(e.date).toLocaleDateString()}</span>
                        <span className={`text-xs px-2 py-0.5 rounded-full ${e.category === 'FAB 亮點' ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-600'}`}>{e.category}</span>
                     </div>
                     <h3 className="font-bold text-slate-800 mb-1 pr-6">{e.title || "無標題週記"}</h3>
                     {e.linkedProjectId && <div className="inline-flex items-center text-xs text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded mb-2"><Link size={10} className="mr-1"/>{projects.find(p => p.id === e.linkedProjectId)?.title || "未知專案"}</div>}
                     <p className="text-sm text-slate-500 line-clamp-2">{e.parsedAnalysis?.summary || e.rawContent}</p>
                     <button onClick={(evt) => deleteEntry(evt, e.id)} className="absolute top-4 right-4 text-slate-300 hover:text-red-500 p-1 z-10">
                        <Trash2 size={16} />
                     </button>
                  </div>
               ))}
            </div>
         </div>
      );
    };

    const FABView = ({ fabList, onUpdateFab }) => {
      const deleteFab = (idx) => {
         if(confirm("確定要刪除這個 FAB 亮點嗎？")) onUpdateFab(fabList.filter((_, i) => i !== idx));
      };
      return (
         <div className="space-y-4 pb-20">
            <h2 className="text-2xl font-black text-slate-900 flex items-center"><Zap className="mr-2 text-amber-500"/>FAB 優勢庫</h2>
            <div className="grid gap-4">
               {fabList.map((fab, idx) => (
                  <div key={idx} className="bg-white p-5 rounded-xl border-l-4 border-amber-400 shadow-sm relative group">
                     <div className="flex justify-between mb-2 pr-6">
                        <span className="text-xs font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded flex items-center"><Star size={10} className="mr-1"/>{fab.tag || "通用優勢"}</span>
                        <span className="text-xs text-slate-300">{new Date(fab.date).toLocaleDateString()}</span>
                     </div>
                     <div className="space-y-2 text-sm">
                        <div className="flex"><span className="font-black text-slate-400 w-6">F</span> <span className="text-slate-800">{fab.feature}</span></div>
                        <div className="flex"><span className="font-black text-indigo-300 w-6">A</span> <span className="text-slate-600">{fab.advantage}</span></div>
                        <div className="flex"><span className="font-black text-green-500 w-6">B</span> <span className="font-bold text-slate-800">{fab.benefit}</span></div>
                     </div>
                     <button onClick={() => deleteFab(idx)} className="absolute top-3 right-3 text-slate-300 hover:text-red-500 p-1">
                        <Trash2 size={16} />
                     </button>
                  </div>
               ))}
            </div>
         </div>
      );
    };

    const ProjectView = ({ projects, onUpdateProjects }) => {
       const [newP, setNewP] = useState('');
       const addP = () => { if(!newP) return; onUpdateProjects([...projects, { id: Date.now().toString(), title: newP, status: 'In Progress' }]); setNewP(''); };
       const deleteProject = (id) => { if(confirm("確定要刪除這個專案嗎？")) onUpdateProjects(projects.filter(p => p.id !== id)); };
       return (
          <div className="space-y-6 pb-20">
             <h2 className="text-2xl font-black text-slate-900">專案管理</h2>
             <div className="flex gap-2">
                <input value={newP} onChange={e=>setNewP(e.target.value)} className="flex-1 p-3 border rounded-xl" placeholder="新專案名稱..."/>
                <button onClick={addP} className="bg-slate-800 text-white px-4 rounded-xl font-bold">+</button>
             </div>
             <div className="space-y-3">
                {projects.map(p => (
                   <div key={p.id} className="bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center">
                      <div className="font-bold text-slate-700 flex items-center">{p.title}</div>
                      <div className="flex items-center gap-3">
                          <button onClick={() => onUpdateProjects(projects.map(pr => pr.id === p.id ? {...pr, status: pr.status === 'Done' ? 'In Progress' : 'Done'} : pr))} className={`text-sm font-bold px-3 py-1 rounded-lg ${p.status === 'Done' ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-500'}`}>{p.status === 'Done' ? '已完成' : '進行中'}</button>
                          <button onClick={() => deleteProject(p.id)} className="text-slate-300 hover:text-red-500 p-1"><Trash2 size={18}/></button>
                      </div>
                   </div>
                ))}
             </div>
          </div>
       );
    };

    const App = () => {
      const [activeTab, setActiveTab] = useState(AppTab.FINANCE);
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
      const [isSyncing, setIsSyncing] = useState(false);
      const [isSettingsOpen, setIsSettingsOpen] = useState(false);
      const [syncStatus, setSyncStatus] = useState('');
      
      // 全域資料狀態
      const [entries, setEntries] = useState([]);
      const [projects, setProjects] = useState([]);
      const [financeData, setFinanceData] = useState([]);
      const [fabList, setFabList] = useState([]);
      const [dataTimestamp, setDataTimestamp] = useState(0); // 用於比較版本

      // 1. 初始化：智慧同步 (本地優先 + 版本比較)
      useEffect(() => {
        const loadData = async () => {
          setIsSyncing(true);
          setSyncStatus('載入中...');
          try {
             // A. 先讀取本地
             const localRaw = localStorage.getItem('lc_data');
             const localData = localRaw ? JSON.parse(localRaw) : {};
             const localTS = localData.dataTimestamp || 0;
             
             // 暫存到 State
             if(localData.entries) setEntries(localData.entries);
             if(localData.projects) setProjects(localData.projects);
             if(localData.fabList) setFabList(localData.fabList);
             if(localData.financeData && localData.financeData.length > 0) setFinanceData(localData.financeData);
             else if(!localRaw) setFinanceData(parseAssetData(INITIAL_RAW_ASSET_DATA));
             setDataTimestamp(localTS);

             // B. 讀取雲端並比較版本
             const res = await fetch(GAS_API_URL);
             const cloudData = await res.json();
             const cloudTS = cloudData.dataTimestamp || 0;

             if (cloudTS > localTS) {
                 // 雲端比較新，更新本地
                 if(cloudData.entries) setEntries(cloudData.entries);
                 if(cloudData.projects) setProjects(cloudData.projects);
                 if(cloudData.financeData) setFinanceData(cloudData.financeData);
                 if(cloudData.fabList) setFabList(cloudData.fabList);
                 setDataTimestamp(cloudTS);
                 // 更新 localStorage
                 localStorage.setItem('lc_data', JSON.stringify(cloudData));
                 setSyncStatus('已更新至雲端最新版');
             } else {
                 setSyncStatus('本地資料已是最新');
             }
          } catch (e) {
              console.error(e);
              setSyncStatus('離線模式 (使用本地資料)');
          } finally {
              setIsSyncing(false);
          }
        };
        loadData();
      }, []);

      // 2. 自動儲存 (Debounce 3s)
      useEffect(() => {
         if (entries.length===0 && projects.length===0 && financeData.length===0) return;

         const timer = setTimeout(async () => {
            const newTS = Date.now(); // 更新時間戳記
            const payload = { entries, projects, financeData, fabList, dataTimestamp: newTS };
            
            // 1. 存本地
            localStorage.setItem('lc_data', JSON.stringify(payload));
            setDataTimestamp(newTS);

            // 2. 推雲端
            setIsSyncing(true);
            setSyncStatus('同步中...');
            try {
               await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
               setSyncStatus(`已同步 ${new Date().toLocaleTimeString()}`);
            } catch(e) {
                setSyncStatus('⚠️ 同步失敗 (資料已存本地)');
            } finally {
                setIsSyncing(false);
            }
         }, 3000);
         return () => clearTimeout(timer);
      }, [entries, projects, financeData, fabList]);

      // 手動強制同步 (覆蓋雲端)
      const handleForceSync = async () => {
          if(!confirm("確定要強制將目前的資料覆寫到雲端嗎？\n(這將以這台裝置的資料為準)")) return;
          setIsSyncing(true);
          setSyncStatus('強制上傳中...');
          const newTS = Date.now();
          const payload = { entries, projects, financeData, fabList, dataTimestamp: newTS };
          try {
              localStorage.setItem('lc_data', JSON.stringify(payload)); // Update local first
              await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
              setSyncStatus(`強制同步完成 ${new Date().toLocaleTimeString()}`);
              alert("雲端資料已更新！");
          } catch(e) {
              alert("上傳失敗，請檢查網路");
              setSyncStatus('上傳失敗');
          } finally {
              setIsSyncing(false);
          }
      };

      // 匯出 JSON
      const handleExport = () => {
          const data = { entries, projects, financeData, fabList, dataTimestamp: Date.now() };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `life_compass_backup_${new Date().toISOString().slice(0,10)}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
      };

      // 匯入 JSON
      const handleImport = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (event) => {
              try {
                  const data = JSON.parse(event.target.result);
                  if(confirm(`確定要還原備份嗎？\n這將覆蓋現有資料，且會自動同步至雲端。`)) {
                      if(data.entries) setEntries(data.entries);
                      if(data.projects) setProjects(data.projects);
                      if(data.financeData) setFinanceData(data.financeData);
                      if(data.fabList) setFabList(data.fabList);
                      alert("還原成功！請等待自動同步完成。");
                  }
              } catch(err) { alert("檔案格式錯誤"); }
          };
          reader.readAsText(file);
      };

      // 重置資產數據 (Hard Reset)
      const handleResetFinance = () => {
          if(confirm("確定要重置資產數據為預設值嗎？(將清除所有手動紀錄)")) {
              setFinanceData(parseAssetData(INITIAL_RAW_ASSET_DATA));
          }
      };

      const renderContent = () => {
         switch(activeTab) {
            case AppTab.JOURNAL: return <JournalView entries={entries} projects={projects} onUpdateEntries={setEntries} apiKey={apiKey} fabList={fabList} onAddFab={(fab) => setFabList([fab, ...fabList])} />;
            case AppTab.PROJECTS: return <ProjectView projects={projects} onUpdateProjects={setProjects} />;
            case AppTab.FINANCE: return <FinanceView data={financeData} onAddData={(d) => setFinanceData([...financeData, d].sort((a,b)=>new Date(a.date)-new Date(b.date)))} onResetData={handleResetFinance} />;
            case AppTab.FAB: return <FABView fabList={fabList} onUpdateFab={setFabList} />;
            default: return <div className="p-10 text-center text-slate-400">功能開發中</div>;
         }
      };

      return (
        <div className="max-w-md mx-auto bg-slate-50 min-h-screen shadow-2xl relative overflow-hidden flex flex-col">
           {isSettingsOpen && (
              <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                 <div className="bg-white rounded-xl p-6 w-full max-w-sm space-y-6">
                    <div className="flex justify-between items-center border-b border-slate-100 pb-3">
                        <h3 className="font-bold text-lg text-slate-800">資料控制台</h3>
                        <button onClick={()=>setIsSettingsOpen(false)} className="text-slate-400 hover:text-slate-600">✕</button>
                    </div>
                    
                    <div className="bg-slate-50 p-3 rounded-lg border border-slate-200 text-xs space-y-1">
                        <div className="flex justify-between"><span className="text-slate-500">版本時間:</span> <span className="font-mono font-bold text-indigo-600">{new Date(dataTimestamp).toLocaleString()}</span></div>
                        <div className="flex justify-between"><span className="text-slate-500">同步狀態:</span> <span className={syncStatus.includes('失敗')?'text-red-500 font-bold':'text-green-600 font-bold'}>{syncStatus}</span></div>
                    </div>

                    <div className="space-y-3">
                        <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">備份與還原</h4>
                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={handleExport} className="flex flex-col items-center justify-center p-3 bg-white border border-slate-200 rounded-xl hover:bg-indigo-50 hover:border-indigo-200 transition text-slate-600 hover:text-indigo-600 shadow-sm">
                                <Download size={20} className="mb-1"/>
                                <span className="text-xs font-bold">下載 JSON</span>
                            </button>
                            <label className="flex flex-col items-center justify-center p-3 bg-white border border-slate-200 rounded-xl hover:bg-amber-50 hover:border-amber-200 transition text-slate-600 hover:text-amber-600 cursor-pointer shadow-sm">
                                <Upload size={20} className="mb-1"/>
                                <span className="text-xs font-bold">上傳 JSON</span>
                                <input type="file" accept=".json" className="hidden" onChange={handleImport}/>
                            </label>
                        </div>
                        <div className="relative">
                            <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200"></div></div>
                            <div className="relative flex justify-center text-xs uppercase"><span className="bg-white px-2 text-slate-400">Danger Zone</span></div>
                        </div>
                        <button onClick={handleForceSync} className="w-full flex items-center justify-center p-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold shadow-lg active:scale-95 transition">
                            <CloudUpload size={18} className="mr-2"/> 強制覆寫雲端資料
                        </button>
                        <p className="text-[10px] text-slate-400 text-center">若手機/電腦資料不一致，請在資料正確的裝置按此鈕。</p>
                    </div>

                    <div className="space-y-2 border-t border-slate-100 pt-4">
                       <h4 className="text-xs font-bold text-slate-400 uppercase">API 設定</h4>
                       <input type="password" placeholder="Gemini API Key" value={apiKey} onChange={e=>{setApiKey(e.target.value); localStorage.setItem('gemini_api_key', e.target.value)}} className="w-full p-2 border rounded text-sm bg-slate-50"/>
                    </div>
                 </div>
              </div>
           )}

           <header className="bg-white/90 backdrop-blur px-4 h-14 flex items-center justify-between border-b border-slate-200 sticky top-0 z-30">
              <div className="font-black text-lg text-slate-800 flex items-center"><Compass className="mr-2 text-indigo-600"/> LifeOS 2.6</div>
              <div className="flex items-center gap-3">
                 <div className="text-[10px] font-medium text-slate-400 flex items-center bg-slate-100 px-2 py-1 rounded-full">
                    {isSyncing ? <RefreshCw size={10} className="animate-spin mr-1 text-indigo-500"/> : <Cloud size={10} className={`mr-1 ${syncStatus.includes('失敗') ? 'text-red-500' : 'text-green-500'}`}/>}
                    <span className="truncate max-w-[80px]">{syncStatus || '就緒'}</span>
                 </div>
                 <button onClick={()=>setIsSettingsOpen(true)}><Settings size={20} className="text-slate-400 hover:text-indigo-600 transition"/></button>
              </div>
           </header>

           <main className="flex-1 p-4 overflow-y-auto custom-scrollbar">{renderContent()}</main>

           <nav className="bg-white border-t border-slate-200 p-2 flex justify-around pb-safe sticky bottom-0 z-30">
              {[
                 {id: AppTab.JOURNAL, icon: BookOpen, label: '覆盤'},
                 {id: AppTab.PROJECTS, icon: Target, label: '專案'},
                 {id: AppTab.FAB, icon: Zap, label: 'FAB'},
                 {id: AppTab.FINANCE, icon: TrendingUp, label: '資產'}
              ].map(t => (
                 <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`flex flex-col items-center p-2 rounded-xl transition ${activeTab===t.id ? 'text-indigo-600 scale-110' : 'text-slate-300'}`}>
                    <t.icon size={24} strokeWidth={2.5}/>
                    <span className="text-[10px] font-bold mt-1">{t.label}</span>
                 </button>
              ))}
           </nav>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
