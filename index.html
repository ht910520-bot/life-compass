<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Life Compass - Cloud Edition</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#f8fafc">
  <meta name="mobile-web-app-capable" content="yes">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>window.process = { env: { NODE_ENV: 'production' } };</script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script crossorigin src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; height: 100vh; overflow-y: auto; overscroll-behavior-y: none; }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    /* 動畫效果 */
    @keyframes pulse-subtle { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .animate-pulse-subtle { animation: pulse-subtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // --- 設定區：你的雲端大腦網址 ---
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbx4S4xt6GsA_Ffdayxg6xHC3wfiKJGdHO8I9hXciCLD27_wCAXgo5TCrYb4a5qSn-K8mQ/exec";

    const { useState, useEffect, useMemo, useRef, useCallback } = React;
    const { createRoot } = ReactDOM;
    const { Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, ResponsiveContainer, Legend, Tooltip } = window.Recharts || {};

    // --- Icons ---
    const IconBase = ({ children, size = 24, className = "", ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
    );
    const Icons = {
      Compass: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></IconBase>,
      Edit3: (p) => <IconBase {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></IconBase>,
      Grid: (p) => <IconBase {...p}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></IconBase>,
      MessageCircle: (p) => <IconBase {...p}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></IconBase>,
      BookOpen: (p) => <IconBase {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>,
      Target: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>,
      Quote: (p) => <IconBase {...p}><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/></IconBase>,
      Zap: (p) => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>,
      Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
      Sparkles: (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3z"/></IconBase>,
      Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
      Calendar: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
      ChevronRight: (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>,
      CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
      Circle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/></IconBase>,
      Settings: (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>,
      Cloud: (p) => <IconBase {...p}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19h-2c-2.485 0-4.5-2.015-4.5-4.5S2.015 10 4.5 10c.174 0 .343.02.51.054C5.83 6.934 8.668 5 11.5 5c4.006 0 7.454 2.816 8.275 6.655 2.484.205 4.225 2.216 4.225 4.845C24 19.015 21.985 21 19.5 21h-2z"/></IconBase>,
      CloudOff: (p) => <IconBase {...p}><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 7h1.8a5 5 0 0 0 1.8 9h8.6"/><line x1="1" y1="1" x2="23" y2="23"/></IconBase>,
      RefreshCw: (p) => <IconBase {...p}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></IconBase>,
      ChevronLeft: (p) => <IconBase {...p}><path d="m15 18-6-6 6-6"/></IconBase>,
      ArrowRight: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>,
      Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>
    };
    
    const { Compass, Edit3, Grid, MessageCircle, BookOpen, Target, Quote, Zap, Save, Sparkles, Trash2, Calendar, ChevronRight, CheckCircle, Circle, Settings, Cloud, CloudOff, RefreshCw, ChevronLeft, ArrowRight, Plus } = Icons;

    // --- API Helper ---
    const callGeminiAPI = async (apiKey, prompt, isJson = false) => {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
      const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: isJson ? { responseMimeType: "application/json" } : {} };
      const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!response.ok) throw new Error((await response.json()).error?.message || 'API 請求失敗');
      return (await response.json()).candidates?.[0]?.content?.parts?.[0]?.text || "";
    };

    // --- Constants ---
    const AppTab = { SELECTOR: 'selector', DEFINITION: 'definition', COMPASS: 'compass', COACH: 'coach', JOURNAL: 'journal', PROJECTS: 'projects' };
    const KEYWORD_GRID = [
      ['成就', '真誠', '學習', '好奇', '健康', '好玩', '發現'], ['成長', '果斷', '朋友', '勇敢', '實踐', '鼓勵', '卓越'],
      ['美感', '理解', '勇敢', '表達', '鼓勵', '尊重', '公益'], ['平衡', '穩定', '冒險', '忠誠', '紀律', '愛', '幽默'],
      ['平靜', '公平', '承諾', '釋放', '投入', '懷舊', '自信'], ['和諧', '正向', '領導', '和平', '專注', '真實', '肯定'],
      ['創新', '野心', '支持', '實現', '想像力', '同理心', '靈性'], ['創造', '多元', '服務', '影響力', '靈感', '夥伴', '溫和'],
      ['金錢', '夥伴', '社群', '實驗', '感官', '安全感', '家人'], ['理想', '堅定', '號召力', '自由', '風險', '幸福', '贏取']
    ];
    const INITIAL_SELECTED_VALUES = ['成長', '平衡', '好奇', '專注', '肯定'];
    const DEFAULT_DEFINITIONS = { '成長': { career: '', relationship: '', life: '' }, '平衡': { career: '', relationship: '', life: '' }, '好奇': { career: '', relationship: '', life: '' }, '專注': { career: '', relationship: '', life: '' }, '肯定': { career: '', relationship: '', life: '' } };
    const USER_PROFILE_DEFAULTS = { strengths: ['跨領域多能者', '傾向理性', '拆解問題'], roles: ['開拓者', '整合者'], philosophy: ['Dream big start small.', '痛苦 + 反省 = 進步。'] };
    const CATEGORY_COLORS = { '個人發展': 'bg-red-100 text-red-700', '職涯規劃': 'bg-orange-100 text-orange-700', '健康管理': 'bg-green-100 text-green-700', '學習成長': 'bg-blue-100 text-blue-700', '科技應用': 'bg-purple-100 text-purple-700', '專業發展': 'bg-pink-100 text-pink-700', '品牌經營': 'bg-indigo-100 text-indigo-700' };

    // --- Sub-Components ---
    const SettingsModal = ({ isOpen, onClose, apiKey, onApiKeySave, onManualSync, isSyncing, lastSaved }) => {
      const [key, setKey] = useState(apiKey);
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
            <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
              <h3 className="text-lg font-bold text-slate-800">設定</h3>
              <button onClick={onClose} className="text-slate-400 text-2xl">&times;</button>
            </div>
            <div className="p-6 space-y-6">
               <div>
                 <h4 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">雲端同步 (Google Sheets)</h4>
                 <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex flex-col items-center">
                    <div className="flex items-center mb-2 space-x-2">
                       {isSyncing ? <RefreshCw className="animate-spin text-indigo-600"/> : <Cloud className="text-indigo-600"/>}
                       <span className="font-bold text-indigo-900">{isSyncing ? "同步中..." : "已連線"}</span>
                    </div>
                    <p className="text-xs text-indigo-600/70 mb-3">{lastSaved ? `上次儲存: ${lastSaved}` : '尚未儲存'}</p>
                    <button onClick={onManualSync} disabled={isSyncing} className="w-full py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 disabled:opacity-50">
                      {isSyncing ? '同步中...' : '立即強制同步'}
                    </button>
                 </div>
               </div>
               <div>
                 <h4 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">AI 金鑰 (Gemini)</h4>
                 <input type="password" value={key} onChange={(e) => setKey(e.target.value)} className="w-full p-2 border rounded-lg text-sm" placeholder="輸入 API Key..." />
                 <div className="flex justify-end mt-2">
                   <button onClick={() => { onApiKeySave(key); onClose(); }} className="bg-slate-800 text-white text-xs px-4 py-2 rounded-lg">儲存</button>
                 </div>
               </div>
            </div>
          </div>
        </div>
      );
    };

    const JournalView = ({ selectedValues, definitions, entries, projects, onUpdateEntries, onAddStrengths, onUpdateProjects, apiKey }) => {
      const [isEditing, setIsEditing] = useState(false);
      const [currentEntry, setCurrentEntry] = useState(null);
      const [inputContent, setInputContent] = useState('');
      const [isAnalyzing, setIsAnalyzing] = useState(false);

      const activeProjects = useMemo(() => projects.filter(p => p.status !== 'Done'), [projects]);

      const handleAnalyze = async () => {
        if (!inputContent.trim() || !apiKey) return alert("請先輸入內容並設定 API Key");
        setIsAnalyzing(true);
        try {
           let valuesContext = selectedValues.map(v => `- ${v}: ${definitions[v]?.life || ''}`).join('\n');
           let projectsContext = activeProjects.map(p => `- ${p.title} (${p.status})`).join('\n');
           const prompt = `你是一位人生教練。請分析以下週記，並回傳 JSON。
           價值觀：${valuesContext}
           專案：${projectsContext}
           週記：${inputContent}
           
           格式：{ "scores": {"價值觀A": 80...}, "summary": "50字摘要", "fab": {"category":"能力類別", "feature":"", "advantage":"", "benefit":""}, "action_items": ["建議"], "project_updates": [{"projectId":"", "suggestedStatus":"Done", "reasoning":""}] }`;
           
           const responseText = await callGeminiAPI(apiKey, prompt, true);
           const parsedResult = JSON.parse(responseText.replace(/```json|```/g, '').trim());
           setCurrentEntry(prev => ({ ...prev, parsedAnalysis: parsedResult }));
        } catch (error) { console.error(error); alert("分析失敗"); } finally { setIsAnalyzing(false); }
      };

      const saveEntry = () => {
        const updated = { ...currentEntry, rawContent: inputContent, date: currentEntry.date || new Date().toISOString() };
        const exists = entries.find(e => e.id === updated.id);
        onUpdateEntries(exists ? entries.map(e => e.id === updated.id ? updated : e) : [updated, ...entries]);
        setIsEditing(false);
      };

      if (isEditing) {
        return (
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[calc(100vh-140px)]">
            <div className="p-3 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
              <button onClick={() => setIsEditing(false)} className="text-slate-500 px-2">← 返回</button>
              <button onClick={saveEntry} className="bg-indigo-600 text-white px-4 py-1.5 rounded-lg flex items-center text-sm"><Save size={16} className="mr-1"/>儲存</button>
            </div>
            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
              <div className="flex-1 p-4 flex flex-col border-r border-slate-100 h-1/2 lg:h-auto overflow-y-auto">
                <textarea value={inputContent} onChange={(e) => setInputContent(e.target.value)} className="flex-1 w-full p-3 bg-slate-50 border border-slate-200 rounded-xl resize-none outline-none text-base" placeholder="本週發生了什麼..." />
                <div className="mt-3 flex justify-end"><button onClick={handleAnalyze} disabled={isAnalyzing} className="bg-amber-500 text-white px-4 py-2 rounded-lg flex items-center text-sm shadow">{isAnalyzing ? '分析中...' : <><Sparkles size={16} className="mr-1"/>AI 覆盤</>}</button></div>
              </div>
              <div className="flex-1 p-4 bg-slate-50/50 overflow-y-auto custom-scrollbar h-1/2 lg:h-auto text-sm">
                {currentEntry?.parsedAnalysis ? (
                  <div className="space-y-4">
                    <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm"><p className="text-slate-700">{currentEntry.parsedAnalysis.summary}</p></div>
                    <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm grid grid-cols-5 gap-1">
                      {Object.entries(currentEntry.parsedAnalysis.scores || {}).map(([k, v]) => (<div key={k} className="text-center"><div className="text-[10px] text-slate-500">{k}</div><div className="font-bold text-indigo-600">{v}</div></div>))}
                    </div>
                    {currentEntry.parsedAnalysis.fab && (
                      <div className="bg-white p-3 rounded-xl border-l-4 border-amber-400 text-xs space-y-1">
                          <div className="font-bold text-amber-600 mb-1">FAB 優勢分析</div>
                          <div><b className="text-slate-400">F:</b> {currentEntry.parsedAnalysis.fab.feature}</div>
                          <div><b className="text-indigo-400">A:</b> {currentEntry.parsedAnalysis.fab.advantage}</div>
                          <div><b className="text-green-500">B:</b> {currentEntry.parsedAnalysis.fab.benefit}</div>
                      </div>
                    )}
                  </div>
                ) : <div className="text-center text-slate-400 py-10">尚無 AI 分析結果</div>}
              </div>
            </div>
          </div>
        );
      }
      return (
        <div className="space-y-4">
           <div className="flex justify-between items-center">
              <h2 className="text-xl font-bold text-slate-800">每週覆盤</h2>
              <button onClick={()=>{setCurrentEntry({id:Date.now().toString(), rawContent:''}); setInputContent(''); setIsEditing(true);}} className="bg-indigo-600 text-white px-4 py-2 rounded-xl flex items-center shadow text-sm"><Plus size={18} className="mr-1"/>寫週記</button>
           </div>
           <div className="space-y-3 pb-20">
             {entries.map(e => (
               <div key={e.id} onClick={() => { setCurrentEntry(e); setInputContent(e.rawContent); setIsEditing(true); }} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center cursor-pointer">
                 <div className="flex items-center space-x-3">
                   <div className="bg-slate-100 p-2 rounded-lg"><Calendar size={20} className="text-slate-500"/></div>
                   <div>
                     <div className="font-bold text-slate-800 text-sm">{new Date(e.date || parseInt(e.id)).toLocaleDateString()}</div>
                     <div className="text-slate-500 text-xs truncate w-40">{e.parsedAnalysis?.summary || "無摘要"}</div>
                   </div>
                 </div>
                 <ChevronRight size={18} className="text-slate-300"/>
               </div>
             ))}
           </div>
        </div>
      );
    };

    const ProjectTracker = ({ projects, onUpdateProjects }) => {
      const [newItem, setNewItem] = useState({ title: '', category: '個人發展', kpi: '' });
      const [isAdding, setIsAdding] = useState(false);
      const toggleProject = (id) => {
        onUpdateProjects(projects.map(p => p.id === id ? { ...p, isCompleted: !p.isCompleted, status: !p.isCompleted ? 'Done' : 'In Progress' } : p));
      };
      const addProject = () => {
        if(!newItem.title) return;
        onUpdateProjects([...projects, { ...newItem, id: Date.now().toString(), isCompleted: false, monthKey: new Date().toISOString().slice(0,7), status: 'Not Started' }]);
        setIsAdding(false); setNewItem({ title: '', category: '個人發展', kpi: '' });
      };
      return (
        <div className="space-y-6 pb-20">
           <h2 className="text-xl font-bold text-slate-800 flex items-center"><Target className="mr-2 text-indigo-600"/>專案追蹤</h2>
           <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
              <div className="divide-y divide-slate-100">
                 {projects.map(p => (
                   <div key={p.id} className="p-4 flex items-center justify-between">
                      <div className="flex items-center space-x-3 overflow-hidden">
                         <button onClick={() => onUpdateProjects(projects.filter(x => x.id !== p.id))} className="text-slate-300"><Trash2 size={14}/></button>
                         <div>
                           <div className={`font-medium text-sm ${p.isCompleted ? 'line-through text-slate-400' : 'text-slate-700'}`}>{p.title}</div>
                           <div className="text-xs text-slate-500 flex gap-2 mt-1"><span className={CATEGORY_COLORS[p.category] + " px-1 rounded"}>{p.category}</span> <span>{p.kpi}</span></div>
                         </div>
                      </div>
                      <button onClick={() => toggleProject(p.id)} className={p.isCompleted ? "text-indigo-500" : "text-slate-300"}>{p.isCompleted ? <CheckCircle size={24}/> : <Circle size={24}/>}</button>
                   </div>
                 ))}
                 {isAdding ? (
                   <div className="p-4 bg-indigo-50 border-t border-indigo-100 space-y-3">
                      <input className="w-full p-2 border rounded text-sm" placeholder="任務名稱" value={newItem.title} onChange={e => setNewItem({...newItem, title: e.target.value})}/>
                      <div className="flex gap-2">
                        <select className="p-2 border rounded text-sm flex-1" value={newItem.category} onChange={e => setNewItem({...newItem, category: e.target.value})}>{Object.keys(CATEGORY_COLORS).map(c=><option key={c} value={c}>{c}</option>)}</select>
                        <input className="p-2 border rounded text-sm flex-1" placeholder="KPI" value={newItem.kpi} onChange={e => setNewItem({...newItem, kpi: e.target.value})}/>
                      </div>
                      <div className="flex justify-end gap-2"><button onClick={() => setIsAdding(false)} className="px-3 py-1 text-slate-500 text-sm">取消</button><button onClick={addProject} className="px-3 py-1 bg-indigo-600 text-white rounded text-sm">新增</button></div>
                   </div>
                 ) : <button onClick={() => setIsAdding(true)} className="w-full p-4 text-slate-400 flex items-center justify-center text-sm hover:bg-slate-50"><Plus size={16} className="mr-1"/>新增任務</button>}
              </div>
           </div>
        </div>
      );
    };

    // --- Main App ---
    const App = () => {
      const [activeTab, setActiveTab] = useState(AppTab.JOURNAL);
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
      const [isSettingsOpen, setIsSettingsOpen] = useState(false);
      const [isSyncing, setIsSyncing] = useState(false);
      const [lastSaved, setLastSaved] = useState(null);
      const [isLoaded, setIsLoaded] = useState(false);

      // Data States
      const [selectedValues, setSelectedValues] = useState(INITIAL_SELECTED_VALUES);
      const [definitions, setDefinitions] = useState(DEFAULT_DEFINITIONS);
      const [userProfile, setUserProfile] = useState(USER_PROFILE_DEFAULTS);
      const [entries, setEntries] = useState([]);
      const [projects, setProjects] = useState([]);
      const [subjectiveRatings, setSubjectiveRatings] = useState({});

      // 1. 初始化：從雲端讀取資料
      useEffect(() => {
        const loadData = async () => {
          setIsSyncing(true);
          try {
            const res = await fetch(GAS_API_URL);
            const data = await res.json();
            if (data && Object.keys(data).length > 0) {
              if (data.entries) setEntries(data.entries);
              if (data.projects) setProjects(data.projects);
              if (data.definitions) setDefinitions(data.definitions);
              if (data.userProfile) setUserProfile(data.userProfile);
              if (data.selectedValues) setSelectedValues(data.selectedValues);
              if (data.subjectiveRatings) setSubjectiveRatings(data.subjectiveRatings);
              console.log("Cloud data loaded");
            } else {
               // Fallback to local storage if cloud is empty (first run)
               const localEntries = JSON.parse(localStorage.getItem('life_compass_journals') || '[]');
               if(localEntries.length > 0) setEntries(localEntries);
            }
          } catch (error) {
            console.error("Load failed:", error);
            alert("無法讀取雲端資料，將使用離線模式");
          } finally {
            setIsSyncing(false);
            setIsLoaded(true);
          }
        };
        loadData();
      }, []);

      // 2. 自動儲存：當資料變更時，延遲 3 秒上傳
      useEffect(() => {
        if (!isLoaded) return;
        
        const saveData = async () => {
           setIsSyncing(true);
           const payload = { selectedValues, definitions, userProfile, entries, projects, subjectiveRatings };
           try {
             await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
             const time = new Date().toLocaleTimeString();
             setLastSaved(time);
             localStorage.setItem('life_compass_journals', JSON.stringify(entries)); // Keep local backup
           } catch (e) { console.error("Save failed", e); }
           finally { setIsSyncing(false); }
        };

        const timer = setTimeout(saveData, 3000); // 3秒 Debounce
        return () => clearTimeout(timer);
      }, [entries, projects, definitions, userProfile, subjectiveRatings, isLoaded]);

      const handleToggleValue = (val) => {
         if (selectedValues.includes(val)) setSelectedValues(prev => prev.filter(v => v !== val));
         else if (selectedValues.length < 5) setSelectedValues(prev => [...prev, val]);
      };

      const renderContent = () => {
        switch (activeTab) {
          case AppTab.JOURNAL: return <JournalView selectedValues={selectedValues} definitions={definitions} userProfile={userProfile} entries={entries} projects={projects} onUpdateEntries={setEntries} onUpdateProjects={setProjects} apiKey={apiKey} />;
          case AppTab.PROJECTS: return <ProjectTracker projects={projects} onUpdateProjects={setProjects} />;
          case AppTab.COMPASS: return (
             <div className="space-y-6">
               <div className="bg-indigo-900 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
                  <div className="relative z-10"><h2 className="text-2xl font-bold">優勢羅盤</h2><p className="opacity-70 text-sm mt-1">{userProfile.philosophy[0]}</p></div>
                  <div className="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full -mr-10 -mt-10"></div>
               </div>
               <div className="bg-white p-4 rounded-xl shadow-sm h-[300px]">
                 <ResponsiveContainer width="100%" height="100%">
                    <RadarChart cx="50%" cy="50%" outerRadius="70%" data={selectedValues.map(v=>({subject:v, A:100, B:Math.random()*100}))}><PolarGrid stroke="#e2e8f0"/><PolarAngleAxis dataKey="subject"/><Radar name="Ideal" dataKey="A" stroke="#cbd5e1" fill="transparent"/><Radar name="Actual" dataKey="B" stroke="#4f46e5" fill="#6366f1" fillOpacity={0.5}/></RadarChart>
                 </ResponsiveContainer>
               </div>
             </div>
          );
          default: return <div className="p-10 text-center text-slate-400">功能開發中...</div>;
        }
      };

      if (!isLoaded) return <div className="h-screen flex flex-col items-center justify-center text-indigo-600"><RefreshCw className="animate-spin mb-2"/><p>正在連線到雲端大腦...</p></div>;

      return (
        <div className="max-w-md mx-auto bg-slate-50 min-h-screen shadow-2xl relative overflow-hidden">
          <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} apiKey={apiKey} onApiKeySave={setApiKey} isSyncing={isSyncing} lastSaved={lastSaved} onManualSync={() => setEntries([...entries])} />

          <header className="bg-white/90 backdrop-blur-sm border-b border-slate-200 px-4 h-14 flex items-center justify-between sticky top-0 z-30">
            <div className="flex items-center space-x-2 font-bold text-slate-800"><Compass className="text-indigo-600"/><span>Life Compass</span></div>
            <div className="flex items-center gap-3">
               <div className="flex items-center text-xs text-slate-400">
                  {isSyncing ? <RefreshCw size={14} className="animate-spin text-indigo-500"/> : <Cloud size={14} className="text-green-500"/>}
               </div>
               <button onClick={() => setIsSettingsOpen(true)} className="p-2 hover:bg-slate-100 rounded-full text-slate-500"><Settings size={20}/></button>
            </div>
          </header>

          <main className="p-4 pb-24">{renderContent()}</main>

          <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 pb-safe max-w-md mx-auto z-40">
            <div className="flex justify-around p-2">
               {[
                 {id: AppTab.JOURNAL, icon: BookOpen, label: '覆盤'},
                 {id: AppTab.PROJECTS, icon: Target, label: '專案'},
                 {id: AppTab.COMPASS, icon: Compass, label: '羅盤'},
                 {id: AppTab.SELECTOR, icon: Grid, label: '價值'}
               ].map(tab => (
                 <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === tab.id ? 'text-indigo-600 scale-110' : 'text-slate-400'}`}>
                    <tab.icon size={24} strokeWidth={activeTab === tab.id ? 2.5 : 2} />
                    <span className="text-[10px] font-bold mt-1">{tab.label}</span>
                 </button>
               ))}
            </div>
          </nav>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>